<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Detecci√≥n de Accidentes</title>
  
  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Leaflet.heat Plugin -->
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <style>
    /* --- Estilos Generales --- */
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#2D2D30;color:#E0E0E0;height:100vh;overflow:hidden;}
    .container{display:flex;height:100vh;flex-direction:column;}
    .header{height:80px;background:linear-gradient(to right,#1E1E1E,#2D2D30);border-bottom:2px solid #444;display:flex;align-items:center;padding:0 20px;color:#E0E0E0;}
    .logo{width:60px;height:60px;background:#E53935;border:2px solid #C62828;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:20px;font-size:24px;font-weight:bold;}
    .header-content{flex:1;}
    .header-title{font-size:22px;font-weight:600;margin-bottom:5px;}
    .header-subtitle{font-size:14px;color:#999;}
    .system-status{background:rgba(255,255,255,0.05);border:1px solid #444;border-radius:8px;padding:15px;min-width:250px;}
    .status-item{display:flex;justify-content:space-between;margin-bottom:8px;font-size:13px;}
    .status-indicator{width:10px;height:10px;border-radius:50%;background:#4CAF50;animation:pulse 2s infinite;}
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.8;transform:scale(1.05);}}
    .main-content{display:flex;flex:1;overflow:hidden;}
    .sidebar{width:220px;background:linear-gradient(to bottom,#252526,#1E1E1E);border-right:2px solid #444;overflow-y:auto;padding:20px 0 120px 0;}
    .menu-button{width:190px;height:45px;margin:5px 15px;border:none;border-radius:8px;color:#E0E0E0;font-family:inherit;cursor:pointer;transition:all 0.3s;font-size:14px;display:flex;align-items:center;gap:10px;padding-left:15px;}
    .menu-button.active{background:#007ACC;border:1px solid #005A9E;}
    .menu-button:not(.active){background:rgba(255,255,255,0.05);border:1px solid #444;}
    .menu-button:hover{background:rgba(255,255,255,0.1);}
    .user-info{position:fixed;bottom:20px;left:15px;width:190px;background:rgba(255,255,255,0.03);border:1px solid #444;border-radius:6px;padding:15px;text-align:center;z-index:100;}
    .content{flex:1;padding:20px;overflow-y:auto;background:#2D2D30;}
    .page{display:none;}
    .page.active{display:block;}
    .card{background:#252526;border:1px solid #444;border-radius:8px;padding:25px;margin-bottom:20px;}
    .card-title{font-size:20px;font-weight:600;margin-bottom:20px;color:#E0E0E0;border-bottom:1px solid #444;padding-bottom:10px;}
    .form-container{background:#252526;border-radius:8px;padding:25px;margin-bottom:20px;border:1px solid #444;}
    .form-row{display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap;}
    .form-group{flex:1;min-width:200px;}
    .form-label{display:block;margin-bottom:8px;color:#E0E0E0;font-size:14px;font-weight:500;}
    .form-input{width:100%;padding:10px;background:#3E3E42;border:1px solid #444;color:#E0E0E0;border-radius:6px;font-size:14px;}
    .btn{padding:10px 20px;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.3s;margin-right:10px;}
    .btn-primary{background:#007ACC;color:white;}
    .btn-primary:hover{background:#005A9E;}
    .btn-danger{background:#E53935;color:white;}
    .btn-danger:hover{background:#C62828;}
    .btn-success{background:#4CAF50;color:white;}
    .btn-success:hover{background:#388E3C;}
    .btn-warning{background:#FF9800;color:white;}
    .btn-warning:hover{background:#F57C00;}
    .camera-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;margin-top:20px;}
    .camera-card{background:#222224;border:1px solid #444;border-radius:8px;padding:15px;text-align:center;position:relative;}
    .camera-preview{width:100%;height:150px;background:#1E1E1E;border-radius:6px;margin-bottom:10px;display:flex;align-items:center;justify-content:center;overflow:hidden;}
    .camera-preview img{width:100%;height:100%;object-fit:cover;}
    .data-table{width:100%;border-collapse:collapse;margin-top:15px;}
    .data-table th,.data-table td{padding:12px;text-align:left;border-bottom:1px solid #444;}
    .data-table th{background:#1E1E1E;}
    .map-frame{width:100%;height:400px;border:0;border-radius:8px;margin-top:15px;}
    canvas{background:#1E1E1E;border:1px solid #444;border-radius:8px;padding:10px;}
    
    /* DVR Grid */
    .dvr-controls{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;}
    .dvr-grid{display:grid;gap:10px;background:#1E1E1E;padding:10px;border-radius:8px;}
    .dvr-grid.grid-1{grid-template-columns:1fr;}
    .dvr-grid.grid-2{grid-template-columns:1fr 1fr;}
    .dvr-grid.grid-4{grid-template-columns:1fr 1fr;}
    .dvr-grid.grid-6{grid-template-columns:1fr 1fr 1fr;}
    .dvr-cell{background:#252526;border:2px solid #444;border-radius:6px;aspect-ratio:16/9;display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;transition:border 0.3s;overflow:hidden;}
    .dvr-cell:hover{border-color:#007ACC;}
    .dvr-cell img{width:100%;height:100%;object-fit:cover;}
    .dvr-cell.fullscreen{position:fixed !important;top:0 !important;left:0 !important;width:100vw !important;height:100vh !important;z-index:1000 !important;border-radius:0 !important;background:#000 !important;cursor:pointer !important;aspect-ratio:auto !important;}
    .dvr-label{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.7);padding:5px 10px;border-radius:4px;font-size:12px;z-index:10;}
    
    /* Detection Panel */
    .detection-panel{background:#1E1E1E;border:1px solid #444;border-radius:8px;padding:15px;margin-bottom:15px;max-height:200px;overflow-y:auto;}
    .detection-item{background:#252526;padding:10px;margin-bottom:8px;border-radius:6px;border-left:4px solid #E53935;display:flex;justify-content:space-between;align-items:center;transition:all 0.3s ease;}
    .detection-item:hover{transform:translateX(5px);box-shadow:0 4px 12px rgba(229,57,53,0.3);}
    
    /* Modal */
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.7);}
    .modal.show{display:flex;align-items:center;justify-content:center;}
    .modal-content{background:#252526;border:1px solid #444;border-radius:8px;padding:30px;min-width:400px;max-width:90%;max-height:90%;overflow-y:auto;}
    .modal-header{font-size:20px;font-weight:600;margin-bottom:20px;border-bottom:1px solid #444;padding-bottom:10px;}
    .modal-close{float:right;font-size:28px;cursor:pointer;color:#999;}
    .modal-close:hover{color:#E53935;}
    
    /* Toast Notifications */
    .toast-container{position:fixed;top:100px;right:20px;z-index:2000;max-width:350px;}
    .toast{background:#252526;border:1px solid #444;border-radius:8px;padding:15px;margin-bottom:10px;box-shadow:0 4px 12px rgba(0,0,0,0.5);animation:slideIn 0.3s;}
    .toast.success{border-left:4px solid #4CAF50;}
    .toast.error{border-left:4px solid #E53935;}
    .toast.warning{border-left:4px solid #FF9800;}
    .toast.info{border-left:4px solid #007ACC;}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0;}to{transform:translateX(0);opacity:1;}}
    
    /* Video Upload */
    .video-preview-container{background:#1E1E1E;padding:20px;border-radius:8px;margin:15px 0;text-align:center;}
    .detections-list{background:#1E1E1E;padding:15px;border-radius:8px;margin:15px 0;}
    .detection-result{background:#252526;padding:12px;margin-bottom:8px;border-radius:6px;border-left:3px solid #FF9800;}
    
    /* Map Controls */
    .map-controls{display:flex;gap:10px;margin-bottom:15px;}
    .map-container{position:relative;}
    .heatmap-overlay{position:absolute;top:15px;right:15px;background:rgba(0,0,0,0.8);padding: 12px 15px;border-radius:8px;font-size:12px;font-weight: bold;color: #fff;border: 2px solid #E53935;box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);z-index: 1000;}
    
    /* Leaflet Map */
    #mapContainer{height:400px;border:1px solid #444;border-radius:8px;margin-top:10px;z-index:1;}
    
    /* NUEVOS ESTILOS PARA YOLO */
    @keyframes borderPulse {
      0%, 100% { 
        border-color: #FF9800;
        box-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
      }
      50% { 
        border-color: #E53935;
        box-shadow: 0 0 20px rgba(229, 57, 53, 0.8);
      }
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    .dvr-cell[data-yolo-active="true"] {
      border-color: #4CAF50 !important;
      box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
    }
    
    .dvr-cell[data-detecting="true"] {
      animation: borderPulse 1s infinite;
    }
    
    .socket-indicator {
      position: fixed;
      top: 90px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 11px;
      border: 1px solid #444;
      z-index: 999;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .socket-indicator.connected { border-color: #4CAF50; }
    .socket-indicator.disconnected { 
      border-color: #E53935;
      animation: blink 1s infinite;
    }
    
    .socket-indicator-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4CAF50;
      animation: pulse 2s infinite;
    }
    
    .socket-indicator.disconnected .socket-indicator-dot {
      background: #E53935;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo">üö®</div>
      <div class="header-content">
        <div class="header-title">Sistema de Detecci√≥n de Accidentes</div>
        <div class="header-subtitle">Monitoreo Inteligente en Tiempo Real</div>
      </div>
      <div class="system-status">
        <div class="status-item"><span>Sistema Activo</span><span class="status-indicator"></span></div>
        <div class="status-item"><span>C√°maras Online</span><span style="color:#4CAF50;" id="cameras-online">0/0</span></div>
        <div class="status-item"><span>√öltima Detecci√≥n</span><span style="color:#FF9800;" id="last-detection">--:--:--</span></div>
        <div class="status-item"><span id="current-time">00:00:00</span></div>
      </div>
    </div>

    <!-- Indicador de conexi√≥n Socket.IO -->
    <div class="socket-indicator connected" id="socketIndicator">
      <div class="socket-indicator-dot"></div>
      <span id="socketStatus">Conectado</span>
    </div>

    <!-- Main -->
    <div class="main-content">
      <div class="sidebar">
        <button  id="btnDashboard" class="menu-button active" onclick="showPage('dashboard')">üìä Dashboard</button>
        <button  id="btnCamaras" class="menu-button" onclick="showPage('camaras')">üìπ C√°maras</button>
        <button  id="btnAgregarCamara" class="menu-button" onclick="showPage('agregar')">‚ûï Agregar C√°mara</button>
        <button  id="btnMonitoreo" class="menu-button" onclick="showPage('monitoreo')">üî¥ Monitoreo DVR</button>
        <button  id="btnRegistros" class="menu-button" onclick="showPage('registros')">üìã Registros</button>
        <button  id="btnSubirVideo" class="menu-button" onclick="showPage('subir')">üì§ Subir Video</button>
        <button  id="btnEstadisticas" class="menu-button" onclick="showPage('estadisticas')">üìà Estad√≠sticas</button>
        <button  id="btnMapa" class="menu-button" onclick="showPage('mapa')">üó∫Ô∏è Mapa</button>
        <button  id="btnConfiguracion" class="menu-button" onclick="showPage('config')">‚öôÔ∏è Configuraci√≥n</button>
        <button  id="btnUsuarios" class="menu-button" onclick="showPage('usuarios')">üë• Usuarios</button>
        <button  id="btnReportes" class="menu-button" onclick="showPage('reportes')">üìÑ Reportes</button>
        <button class="menu-button" onclick="logout()">üö™ Salir</button>
        <div class="user-info">
           <div><b id="userNameLabel">üë§ Administrador</b></div>
           <div id="userRoleLabel" style="font-size:12px;color:#999;">Sesi√≥n activa</div>
        </div>
      </div>

      <!-- Content -->
      <div class="content">
        <!-- Dashboard -->
        <div id="dashboard" class="page active">
          <div class="card">
            <div class="card-title">Resumen General</div>
            <div class="form-row">
              <div class="form-group">
                <div style="text-align:center;padding:20px;background:#1E1E1E;border-radius:8px;">
                  <div style="font-size:36px;color:#4CAF50;font-weight:bold;" id="dash-cams">0</div>
                  <div style="color:#999;">C√°maras Activas</div>
                </div>
              </div>
              <div class="form-group">
                <div style="text-align:center;padding:20px;background:#1E1E1E;border-radius:8px;">
                  <div style="font-size:36px;color:#E53935;font-weight:bold;" id="dash-accidents">0</div>
                  <div style="color:#999;">Accidentes Registrados</div>
                </div>
              </div>
              <div class="form-group">
                <div style="text-align:center;padding:20px;background:#1E1E1E;border-radius:8px;">
                  <div style="font-size:36px;color:#FF9800;font-weight:bold;" id="dash-users">0</div>
                  <div style="color:#999;">Usuarios Activos</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- C√°maras -->
        <div id="camaras" class="page">
          <div class="card">
            <div class="card-title">C√°maras Registradas</div>
            <div id="cameraList" class="camera-grid"></div>
          </div>
        </div>

        <!-- Agregar C√°mara -->
        <div id="agregar" class="page">
          <div class="form-container">
            <div class="card-title">Agregar Nueva C√°mara</div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Direcci√≥n IP *</label>
                <input id="camIP" class="form-input" placeholder="192.168.1.100" required>
              </div>
              <div class="form-group">
                <label class="form-label">Puerto</label>
                <input id="camPort" class="form-input" placeholder="554" value="554">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Usuario</label>
                <input id="camUser" class="form-input" placeholder="admin" value="admin">
              </div>
              <div class="form-group">
                <label class="form-label">Contrase√±a</label>
                <input type="password" id="camPass" class="form-input" placeholder="password">
              </div>
            </div>
            
            <!-- MAPA INTERACTIVO -->
            <div class="form-group" style="min-width:100%;">
              <label class="form-label">üìç Seleccione la ubicaci√≥n en el mapa (haga clic para marcar) *</label>
              <div id="mapContainer"></div>
              <button class="btn btn-primary" onclick="useMyLocation()" style="margin-top:10px;">üìç Usar mi ubicaci√≥n</button>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Latitud *</label>
                <input id="camLat" class="form-input" placeholder="4.6097" readonly required>
              </div>
              <div class="form-group">
                <label class="form-label">Longitud *</label>
                <input id="camLng" class="form-input" placeholder="-74.0817" readonly required>
              </div>
            </div>
            
            <button class="btn btn-primary" onclick="addCamera()">üíæ Guardar C√°mara</button>
          </div>
        </div>

        <!-- Monitoreo DVR -->
        <div id="monitoreo" class="page">
          <div class="card">
            <div class="card-title">Monitoreo en Vivo - Vista DVR</div>
            
            <!-- Panel de Estado YOLO -->
            <div class="card" style="margin-bottom:15px;background:linear-gradient(135deg, #1E1E1E 0%, #2D2D30 100%);">
              <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">
                <div style="flex:1;min-width:200px;">
                  <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                    <div style="width:40px;height:40px;background:#4CAF50;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;">üéØ</div>
                    <div>
                      <div style="font-size:16px;font-weight:bold;">Sistema YOLO</div>
                      <div style="font-size:11px;color:#4CAF50;">‚óè Activo y Monitoreando</div>
                    </div>
                  </div>
                  <div style="font-size:11px;color:#999;">Detecci√≥n en tiempo real con verificaci√≥n anti falsos positivos</div>
                </div>
                
                <div style="flex:1;min-width:200px;background:rgba(255,255,255,0.03);padding:15px;border-radius:8px;border:1px solid #444;">
                  <div style="font-size:12px;font-weight:bold;margin-bottom:10px;">‚öôÔ∏è Configuraci√≥n Activa</div>
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:11px;">
                    <div style="color:#999;">Frames requeridos:</div>
                    <div id="live-config-frames" style="color:#4CAF50;font-weight:bold;text-align:right;">120 consecutivos</div>
                    <div style="color:#999;">Cooldown:</div>
                    <div id="live-config-cooldown" style="color:#FF9800;font-weight:bold;text-align:right;">60 segundos</div>
                    <div style="color:#999;">Confianza m√≠nima:</div>
                    <div id="live-config-confidence" style="color:#007ACC;font-weight:bold;text-align:right;">75%</div>
                  </div>
                </div>
                
                <div style="flex:1;min-width:250px;background:rgba(229,57,53,0.1);padding:15px;border-radius:8px;border:1px solid #E53935;">
                  <div style="font-size:12px;font-weight:bold;margin-bottom:10px;color:#E53935;">üìä Estad√≠sticas Globales</div>
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <div style="text-align:center;background:rgba(255,152,0,0.2);padding:8px;border-radius:6px;">
                      <div style="font-size:18px;font-weight:bold;color:#FF9800;" id="global-total-detections">0</div>
                      <div style="color:#999;font-size:10px;">Detecciones</div>
                    </div>
                    <div style="text-align:center;background:rgba(229,57,53,0.2);padding:8px;border-radius:6px;">
                      <div style="font-size:18px;font-weight:bold;color:#E53935;" id="global-confirmed-accidents">0</div>
                      <div style="color:#999;font-size:10px;">Confirmados</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Detection Panel -->
            <div class="detection-panel">
              <div style="font-weight:bold;margin-bottom:10px;">üî¥ Detecciones en Tiempo Real</div>
              <div id="detection-feed">
                <div style="color:#999;text-align:center;padding:20px;">Esperando detecciones...</div>
              </div>
            </div>
            
            <!-- DVR Controls -->
            <div class="dvr-controls">
              <button class="btn btn-primary" onclick="setDVRGrid(1)">1 C√°mara</button>
              <button class="btn btn-primary" onclick="setDVRGrid(2)">2 C√°maras</button>
              <button class="btn btn-primary" onclick="setDVRGrid(4)">4 C√°maras</button>
              <button class="btn btn-primary" onclick="setDVRGrid(6)">6 C√°maras</button>
            </div>
            
            <!-- DVR Grid -->
            <div id="dvrGrid" class="dvr-grid grid-4"></div>
          </div>
        </div>

        <!-- Registros -->
        <div id="registros" class="page">
          <div class="card">
            <div class="card-title">Registros de Accidentes</div>
            <button class="btn btn-success" onclick="exportToCSV()">üì• Exportar a CSV</button>
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Fecha</th>
                  <th>Hora</th>
                  <th>Archivo</th>
                  <th>C√°mara</th>
                  <th>Ubicaci√≥n</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="registrosTable"></tbody>
            </table>
          </div>
        </div>

        <!-- Subir Video -->
        <div id="subir" class="page">
          <div class="card">
            <div class="card-title">Subir Video para An√°lisis</div>
            <div class="form-group">
              <label class="form-label">Seleccionar Video</label>
              <input type="file" accept="video/*" class="form-input" onchange="previewVideo(event)" id="videoInput">
            </div>
            <div class="video-preview-container">
              <video id="videoPreview" controls width="600" style="max-width:100%;display:none;"></video>
            </div>
            <button class="btn btn-warning" onclick="analyzeVideo()" id="analyzeBtn" disabled>üîç Analizar Video</button>
            
            <div id="analysisResults" style="display:none;">
              <div class="card-title" style="margin-top:20px;">Resultados del An√°lisis</div>
              <div class="detections-list" id="detectionsList"></div>
              <button class="btn btn-success" onclick="downloadResults()">üì• Descargar Resultados</button>
            </div>
          </div>
        </div>

<!-- Estad√≠sticas -->
        <div id="estadisticas" class="page">
          <!-- Resumen General -->
          <div class="card">
            <div class="card-title">üìä Resumen General del Sistema</div>
            <div class="form-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
              <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #E53935 0%, #C62828 100%); border-radius: 10px;">
                <div style="font-size: 48px; font-weight: bold; color: #FFF;" id="stat-total-accidents">0</div>
                <div style="font-size: 14px; color: rgba(255,255,255,0.9); margin-top: 5px;">Total Accidentes</div>
              </div>
              <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); border-radius: 10px;">
                <div style="font-size: 48px; font-weight: bold; color: #FFF;" id="stat-cameras-active">0</div>
                <div style="font-size: 14px; color: rgba(255,255,255,0.9); margin-top: 5px;">C√°maras Activas</div>
              </div>
              <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); border-radius: 10px;">
                <div style="font-size: 48px; font-weight: bold; color: #FFF;" id="stat-last-24h">0</div>
                <div style="font-size: 14px; color: rgba(255,255,255,0.9); margin-top: 5px;">√öltimas 24 Horas</div>
              </div>
              <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); border-radius: 10px;">
                <div style="font-size: 48px; font-weight: bold; color: #FFF;" id="stat-avg-per-day">0</div>
                <div style="font-size: 14px; color: rgba(255,255,255,0.9); margin-top: 5px;">Promedio Diario</div>
              </div>
            </div>
          </div>

          <!-- Accidentes por Hora -->
          <div class="card">
            <div class="card-title">‚è∞ Accidentes por Hora del D√≠a</div>
            <canvas id="hourChart" height="80"></canvas>
          </div>

          <!-- Severidad -->
          <div class="card">
            <div class="card-title">üö® Distribuci√≥n por Severidad</div>
            <div class="form-row" style="gap: 20px;">
              <div style="flex: 1; min-width: 300px;">
                <canvas id="severityChart" height="200"></canvas>
              </div>
              <div style="flex: 1; min-width: 300px;">
                <div id="severity-legend" style="display: flex; flex-direction: column; gap: 15px; padding: 20px;"></div>
              </div>
            </div>
          </div>

          <!-- Top C√°maras -->
          <div class="card">
            <div class="card-title">üìπ Top 10 C√°maras</div>
            <canvas id="cameraChart" height="100"></canvas>
          </div>

          <!-- Tendencia -->
          <div class="card">
            <div class="card-title">üìà √öltimos 7 D√≠as</div>
            <canvas id="weeklyChart" height="80"></canvas>
          </div>
        </div>

<!-- Mapa -->
        <div id="mapa" class="page">
          <div class="card">
            <div class="card-title">üó∫Ô∏è Mapa de Accidentes y C√°maras</div>
            
            <div class="map-controls" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
              <button class="btn btn-primary" onclick="toggleHeatmap1()">üî• <span id="heatmap-btn-text">Activar Mapa de Calor</span></button>
              <button class="btn btn-primary" onclick="showAllCameras()">üìπ Mostrar C√°maras</button>
              <button class="btn btn-success" onclick="showAllAccidents()">üö® Mostrar Accidentes</button>
              <button class="btn btn-warning" onclick="filterBySeverity('CR√çTICA')">‚ö†Ô∏è Solo Cr√≠ticos</button>
              <button class="btn" style="background:#666;" onclick="clearMapMarkers()">üóëÔ∏è Limpiar</button>
            </div>
            
            <div style="background: #1E1E1E; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <div style="font-weight: bold; margin-bottom: 10px;">üìä Leyenda</div>
              <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 20px; background: #4CAF50; border-radius: 50%;"></div><span>BAJA</span></div>
                <div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 20px; background: #FF9800; border-radius: 50%;"></div><span>MEDIA</span></div>
                <div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 20px; background: #E53935; border-radius: 50%;"></div><span>ALTA</span></div>
                <div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 20px; background: #B71C1C; border-radius: 50%; box-shadow: 0 0 10px #B71C1C;"></div><span>CR√çTICA</span></div>
              </div>
            </div>
            
            <div style="position: relative;">
              <div id="mapContainerMapa" style="height: 600px; border-radius: 12px; overflow: hidden; border: 2px solid #444;"></div>
              <div id="heatmapInfo" style="position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.85); padding: 15px; border-radius: 8px; font-size: 12px; display: none; border: 1px solid #444;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #FF9800;">üî• Mapa de Calor</div>
                <div style="color: #E53935;">üî¥ Alta</div>
                <div style="color: #FF9800;">üü° Media</div>
                <div style="color: #4CAF50;">üü¢ Baja</div>
              </div>
              <div style="position: absolute; bottom: 15px; left: 15px; background: rgba(0,0,0,0.85); padding: 15px; border-radius: 8px; font-size: 12px; border: 1px solid #444;">
                <div style="font-weight: bold; margin-bottom: 8px;">üìä Stats</div>
                <div>üìπ C√°maras: <span id="map-stat-cameras" style="color: #2196F3; font-weight: bold;">0</span></div>
                <div>üö® Accidentes: <span id="map-stat-accidents" style="color: #E53935; font-weight: bold;">0</span></div>
                <div>‚ö†Ô∏è Cr√≠ticos: <span id="map-stat-critical" style="color: #B71C1C; font-weight: bold;">0</span></div>
              </div>
            </div>
          </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.js"></script>

        <!-- Configuraci√≥n -->
        <div id="config" class="page">
          <div class="form-container">
            <div class="card-title">‚öôÔ∏è Configuraci√≥n del Sistema YOLO</div>
            
            <!-- YOLO y Detecci√≥n -->
            <div style="background:#1E1E1E;padding:20px;border-radius:8px;margin-bottom:20px;border:2px solid #4CAF50;">
              <h3 style="color:#4CAF50;margin-bottom:15px;">üéØ Detecci√≥n de Accidentes</h3>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Frames Requeridos para Confirmar</label>
                  <input type="number" class="form-input" id="config_frames_requeridos" min="10" max="300" step="1">
                  <small style="color:#999;font-size:11px;">Frames consecutivos necesarios (m√°s = menos falsos positivos)</small>
                </div>
                <div class="form-group">
                  <label class="form-label">Cooldown entre Confirmaciones (segundos)</label>
                  <input type="number" class="form-input" id="config_cooldown_segundos" min="10" max="300" step="5">
                  <small style="color:#999;font-size:11px;">Tiempo de espera entre accidentes confirmados</small>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Confianza M√≠nima YOLO (0-1)</label>
                  <input type="number" class="form-input" id="config_confianza_minima" min="0.1" max="1.0" step="0.05">
                  <small style="color:#999;font-size:11px;">Umbral de confianza del modelo (0.75 = 75%)</small>
                </div>
                <div class="form-group">
                  <label class="form-label">Notificaciones</label>
                  <select class="form-input" id="config_notificaciones">
                    <option value="all">Todas</option>
                    <option value="critical">Solo Cr√≠ticas</option>
                    <option value="none">Ninguna</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Grabaci√≥n de Video -->
            <div style="background:#1E1E1E;padding:20px;border-radius:8px;margin-bottom:20px;border:2px solid #FF9800;">
              <h3 style="color:#FF9800;margin-bottom:15px;">üé¨ Configuraci√≥n de Grabaci√≥n</h3>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Segundos Previos (Buffer)</label>
                  <input type="number" class="form-input" id="config_tiempo_grabacion_pre" min="5" max="30" step="1">
                  <small style="color:#999;font-size:11px;">Frames guardados ANTES de la detecci√≥n</small>
                </div>
                <div class="form-group">
                  <label class="form-label">Segundos Posteriores</label>
                  <input type="number" class="form-input" id="config_tiempo_grabacion_post" min="5" max="60" step="1">
                  <small style="color:#999;font-size:11px;">Segundos grabados DESPU√âS de la confirmaci√≥n</small>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Formato de Video</label>
                  <select class="form-input" id="config_formato_video">
                    <option value="mp4">MP4 (Recomendado)</option>
                    <option value="avi">AVI</option>
                    <option value="mkv">MKV</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Ruta de Almacenamiento</label>
                  <input type="text" class="form-input" id="config_ruta_videos" placeholder="C:\Videos\Accidentes">
                </div>
              </div>
            </div>
            
            <!-- Botones -->
            <div style="display:flex;gap:10px;">
              <button class="btn btn-primary" onclick="saveConfig()">üíæ Guardar y Aplicar Cambios</button>
              <button class="btn btn-warning" onclick="loadConfig()">üîÑ Recargar Configuraci√≥n</button>
              <button class="btn" style="background:#666;" onclick="resetConfig()">‚Ü©Ô∏è Restaurar Valores por Defecto</button>
            </div>
            
            <!-- Info -->
            <div style="margin-top:20px;padding:15px;background:rgba(255,152,0,0.1);border-left:4px solid #FF9800;border-radius:6px;">
              <strong>‚ö†Ô∏è Importante:</strong> Los cambios se aplicar√°n a todas las c√°maras activas. Las c√°maras se reiniciar√°n autom√°ticamente para aplicar la nueva configuraci√≥n.
            </div>
          </div>
        </div>

<!-- Usuarios -->
        <div id="usuarios" class="page">
          <div class="card">
            <div class="card-title">üë• Gesti√≥n de Usuarios</div>
            <button class="btn btn-primary" onclick="openUserModal('create')">‚ûï Agregar</button>
            <button class="btn btn-warning" onclick="loadUsers()">üîÑ Recargar</button>
            <table class="data-table">
              <thead>
                <tr><th>ID</th><th>Nombre</th><th>Correo</th><th>Rol</th><th>Estado</th><th>√öltimo Login</th><th>Acciones</th></tr>
              </thead>
              <tbody id="usersTable">
                <tr><td colspan="7" style="text-align: center; color: #999;">Cargando...</td></tr>
              </tbody>
            </table>
          </div>
        </div>


        <!-- Reportes -->
        <div id="reportes" class="page">
          <div class="card">
            <div class="card-title">Sistema de Reportes</div>
            
            <!-- Filtros de Fecha -->
            <div class="form-row" style="margin-bottom:20px;">
              <div class="form-group">
                <label class="form-label">Fecha Inicio</label>
                <input type="date" id="report-start-date" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">Fecha Fin</label>
                <input type="date" id="report-end-date" class="form-input">
              </div>
              <div class="form-group" style="display:flex;align-items:flex-end;">
                <button class="btn btn-primary" onclick="loadAllReports()">üîç Filtrar</button>
              </div>
            </div>
            
            <!-- Pesta√±as -->
            <div style="display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #444;">
              <button class="btn btn-primary" id="tab-audit" onclick="showReportTab('audit')" style="border-radius:8px 8px 0 0;">üìã Auditor√≠a</button>
              <button class="btn" id="tab-access" onclick="showReportTab('access')" style="background:#3E3E42;border-radius:8px 8px 0 0;">üîê Accesos</button>
              <button class="btn" id="tab-accidents" onclick="showReportTab('accidents')" style="background:#3E3E42;border-radius:8px 8px 0 0;">üö® Accidentes</button>
            </div>
            
            <!-- Tabla de Auditor√≠a -->
            <div id="report-audit-content" class="report-content">
              <button class="btn btn-success" onclick="exportReport('audit')" style="margin-bottom:15px;">üì• Exportar CSV</button>
              <table class="data-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Tipo Evento</th>
                    <th>Usuario</th>
                    <th>Descripci√≥n</th>
                    <th>Fecha/Hora</th>
                    <th>IP</th>
                  </tr>
                </thead>
                <tbody id="audit-table-body">
                  <tr><td colspan="6" style="text-align:center;color:#999;">Cargando...</td></tr>
                </tbody>
              </table>
            </div>
            
            <!-- Tabla de Accesos -->
            <div id="report-access-content" class="report-content" style="display:none;">
              <button class="btn btn-success" onclick="exportReport('access')" style="margin-bottom:15px;">üì• Exportar CSV</button>
              <table class="data-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Fecha/Hora</th>
                    <th>Usuario</th>
                    <th>Correo</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>IP</th>
                  </tr>
                </thead>
                <tbody id="access-table-body">
                  <tr><td colspan="7" style="text-align:center;color:#999;">Cargando...</td></tr>
                </tbody>
              </table>
            </div>
            
            <!-- Tabla de Accidentes -->
            <div id="report-accidents-content" class="report-content" style="display:none;">
              <button class="btn btn-success" onclick="exportReport('accidents')" style="margin-bottom:15px;">üì• Exportar CSV</button>
              <table class="data-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Fecha/Hora</th>
                    <th>C√°mara</th>
                    <th>Ubicaci√≥n</th>
                    <th>Latitud</th>
                    <th>Longitud</th>
                    <th>Video</th>
                  </tr>
                </thead>
                <tbody id="accidents-table-body">
                  <tr><td colspan="7" style="text-align:center;color:#999;">Cargando...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

  <!-- Modal Usuario Edit -->
  <div id="userModalEdit" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-close" onclick="closeUserModalEdit()">&times;</span>
        <span id="modalUserTitle">Usuario</span>
      </div>
      <input type="hidden" id="editUserId">
      <div class="form-group"><label class="form-label">Nombre *</label><input type="text" class="form-input" id="editUserName"></div>
      <div class="form-group"><label class="form-label">Correo *</label><input type="email" class="form-input" id="editUserEmail"></div>
      <div class="form-group"><label class="form-label">Contrase√±a (vac√≠o = mantener)</label><input type="password" class="form-input" id="editUserPassword"></div>
      <div class="form-group">
        <label class="form-label">Rol *</label>
        <select class="form-input" id="editUserRole">
          <option value="admin">Admin</option>
          <option value="operador">Operador</option>
          <option value="emergencias">Emergencias</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="saveUserEdit()">üíæ Guardar</button>
      <button class="btn" style="background:#666;" onclick="closeUserModalEdit()">Cancelar</button>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

<script>
  // === A√ëADIR TOKEN JWT AUTOM√ÅTICAMENTE A TODAS LAS PETICIONES ===
  const originalFetch = window.fetch;
  window.fetch = async (url, options = {}) => {
    const session = localStorage.getItem("session") || sessionStorage.getItem("session");
    if (session) {
      const token = JSON.parse(session).token;
      options.headers = {
        ...(options.headers || {}),
        "Authorization": "Bearer " + token
      };
    }
    return originalFetch(url, options);
  };
  
    document.addEventListener("DOMContentLoaded", () => {
      const permisos = JSON.parse(sessionStorage.getItem("permissions") || "{}");

      const mapaBotones = {
        dashboard: "btnDashboard",
        camaras: "btnCamaras",
        agregar_camara: "btnAgregarCamara",
        monitoreo: "btnMonitoreo",
        registros: "btnRegistros",
        subir_video: "btnSubirVideo",
        estadisticas: "btnEstadisticas",
        mapa: "btnMapa",
        config: "btnConfiguracion",
        usuarios: "btnUsuarios",
        reportes: "btnReportes",
      };

      for (const permiso in mapaBotones) {
        const id = mapaBotones[permiso];
        const boton = document.getElementById(id);
        if (boton && !permisos[permiso]) {
          boton.style.display = "none";
        }
      }
    });
  
    
document.addEventListener("DOMContentLoaded", () => {
  const session = JSON.parse(localStorage.getItem("session") || sessionStorage.getItem("session") || "{}");

  const nameLabel = document.getElementById("userNameLabel");
  const roleLabel = document.getElementById("userRoleLabel");

  if (session && session.nombre && session.rol) {
    nameLabel.textContent = `üë§ ${session.nombre}`;
    roleLabel.textContent = `Rol: ${session.rol.charAt(0).toUpperCase() + session.rol.slice(1)}`;
  } else {
    nameLabel.textContent = "üë§ Usuario";
    roleLabel.textContent = "Sesi√≥n activa";
  }
});

  // ============================================
  // CONFIGURACI√ìN
  // ============================================
  const API_URL = 'https://accident-detector.site/api';

  // ============================================
// CONEXI√ìN WEBSOCKET (Socket.IO)
// ============================================
  const socket = io('https://accident-detector.site', {
    
    transports: ['websocket'],  // Fuerza WebSocket (sin polling)
    path: '/socket.io',
    reconnection: true,
    reconnectionAttempts: 5,
    reconnectionDelay: 2000
  });

  socket.onAny((event, data) => {
    console.log('üì® Evento recibido:', event, data);
  });

  socket.on('connect', () => {
    const indicator = document.getElementById('socketIndicator');
    const status = document.getElementById('socketStatus');
    if (indicator && status) {
      indicator.className = 'socket-indicator connected';
      status.innerText = 'Conectado';
    }
    console.log('‚úÖ Socket conectado correctamente al backend');
    showToast('Conectado al servidor', 'success');
    loadAllData();
  });

  socket.on('disconnect', () => {
    const indicator = document.getElementById('socketIndicator');
    const status = document.getElementById('socketStatus');
    if (indicator && status) {
      indicator.className = 'socket-indicator disconnected';
      status.innerText = 'Desconectado';
    }
    console.warn('‚ö†Ô∏è Socket desconectado');
    showToast('Desconectado del servidor', 'warning');
  });

  socket.on('connect_error', (err) => {
    console.error('‚ùå Error al conectar con backend:', err.message);
    showToast('Error al conectar con backend', 'error');
  });



  // ============================================
  // LISTENERS DE DETECCI√ìN YOLO
  // ============================================

  // Escuchar detecciones TENTATIVAS (sin confirmar)
  socket.on('tentative_detection', (data) => {
    console.log('‚ö†Ô∏è Detecci√≥n tentativa:', data);
    
    // ‚úÖ AGREGAR required_frames desde la config
    if (window.liveConfig) {
      data.required_frames = window.liveConfig.frames_requeridos;
    }
    
    updateDetectionProgress(data);
  }); 

  // Escuchar ACCIDENTES CONFIRMADOS
  socket.on('severe_detected', (data) => {
    console.log('üö® ACCIDENTE CONFIRMADO:', data);
    showToast(`ACCIDENTE CONFIRMADO - C√°mara ${data.camera_ip} (${data.confidence}%)`, 'error');
    addConfirmedDetectionToFeed(data);
    playAlertSound();
    showDesktopNotification(data);
    document.getElementById('last-detection').innerText = new Date().toLocaleTimeString();
    
    // Actualizar gr√°ficas en tiempo real
    updateChartsWithNewDetection(data);
    
    // Recargar registros
    loadAccidents();
    updateGlobalStats();
  });

  // Estado global
  let cameras = [];
  let accidents = [];
  let users = [];
  let currentGrid = 4;
  let map = null;
  let marker = null;

  // ============================================
  // FUNCIONES DE DETECCI√ìN VISUAL
  // ============================================

function updateDetectionProgress(data) {
  const feed = document.getElementById('detection-feed');
  let progressItem = document.getElementById(`progress-cam-${data.camera_id}`);
  
  if (!progressItem) {
    const waiting = feed.querySelector('[style*="text-align:center"]');
    if (waiting) waiting.remove();
    
    progressItem = document.createElement('div');
    progressItem.id = `progress-cam-${data.camera_id}`;
    progressItem.className = 'detection-item';
    progressItem.style.borderLeft = '4px solid #FF9800';
    progressItem.style.background = '#2a2a2a';
    feed.insertBefore(progressItem, feed.firstChild);
  }
  
  // ‚úÖ USAR VALORES DIN√ÅMICOS (actualizar desde la configuraci√≥n live)
  const requiredFrames = window.liveConfig?.frames_requeridos || data.required_frames || 120;
  const progress = (data.consecutive_frames / requiredFrames) * 100;
  const progressColor = progress >= 100 ? '#4CAF50' : '#FF9800';
  
  progressItem.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="flex:1;">
        <div style="font-weight:bold;color:#FF9800;">‚ö†Ô∏è VERIFICANDO ACCIDENTE</div>
        <div style="font-size:11px;color:#999;margin-top:4px;">
          C√°mara ${data.camera_ip} - ${new Date(data.timestamp).toLocaleTimeString()}
        </div>
        <div style="font-size:11px;color:#4CAF50;margin-top:2px;">
          Confianza: ${data.confidence}%
        </div>
        <div style="margin-top:8px;">
          <div style="background:#1E1E1E;border-radius:10px;height:20px;overflow:hidden;">
            <div style="background:${progressColor};height:100%;width:${progress}%;transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:#000;font-size:10px;font-weight:bold;">
              ${data.consecutive_frames}/${requiredFrames}
            </div>
          </div>
        </div>
      </div>
      <div style="margin-left:15px;">
        <div style="width:50px;height:50px;border-radius:50%;border:3px solid ${progressColor};display:flex;align-items:center;justify-content:center;font-size:18px;">
          ${progress >= 100 ? '‚úì' : '...'}
        </div>
      </div>
    </div>
  `;
  
  setTimeout(() => {
    if (progressItem && progressItem.parentNode) {
      progressItem.style.opacity = '0';
      progressItem.style.transition = 'opacity 0.5s';
      setTimeout(() => progressItem.remove(), 500);
    }
  }, 5000);
}

  // ============================================
  // ACTUALIZACI√ìN DE CONFIGURACI√ìN EN TIEMPO REAL
  // ============================================
  
  let liveConfigInterval = null;
  window.liveConfig = null; // Variable global para acceder desde otras funciones
  
  async function updateLiveConfig() {
    try {
      const response = await fetch(`${API_URL}/config/live`);
      const data = await response.json();
      
      if (data.success) {
        window.liveConfig = data.config;
        
        // Actualizar panel de configuraci√≥n
        const framesEl = document.getElementById('live-config-frames');
        const cooldownEl = document.getElementById('live-config-cooldown');
        const confidenceEl = document.getElementById('live-config-confidence');
        
        if (framesEl) {
          framesEl.innerText = `${data.config.frames_requeridos || 120} consecutivos`;
        }
        
        if (cooldownEl) {
          cooldownEl.innerText = `${data.config.cooldown_segundos || 60} segundos`;
        }
        
        if (confidenceEl) {
          const confidencePercent = Math.round((data.config.confianza_minima || 0.75) * 100);
          confidenceEl.innerText = `${confidencePercent}%`;
        }
        
        // Actualizar valores en DVR stats
        cameras.forEach(cam => {
          const reqSpan = document.getElementById(`dvr-required-${cam.id}`);
          if (reqSpan) {
            reqSpan.innerText = data.config.frames_requeridos || 120;
          }
        });
      }
    } catch (error) {
      console.error('Error actualizando configuraci√≥n live:', error);
    }
  }
  
  function startLiveConfigUpdates() {
    // Actualizar inmediatamente
    updateLiveConfig();
    
    // Actualizar cada 10 segundos
    if (liveConfigInterval) clearInterval(liveConfigInterval);
    liveConfigInterval = setInterval(updateLiveConfig, 10000);
  }
  
  function stopLiveConfigUpdates() {
    if (liveConfigInterval) {
      clearInterval(liveConfigInterval);
      liveConfigInterval = null;
    }
  }

  function addConfirmedDetectionToFeed(data) {
    const feed = document.getElementById('detection-feed');
    const progressItem = document.getElementById(`progress-cam-${data.camera_id}`);
    if (progressItem) progressItem.remove();
    
    const item = document.createElement('div');
    item.className = 'detection-item';
    item.style.borderLeft = '4px solid #E53935';
    item.style.background = '#2D1B1B';
    item.style.animation = 'pulse 2s ease-in-out 3';
    
    item.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-weight:bold;color:#E53935;display:flex;align-items:center;gap:8px;">
            üö® ACCIDENTE CONFIRMADO
            <span style="background:#E53935;color:#fff;padding:2px 8px;border-radius:4px;font-size:10px;">SEVERE</span>
          </div>
          <div style="font-size:11px;color:#999;margin-top:4px;">
            C√°mara ${data.camera_ip} - ${new Date(data.timestamp).toLocaleTimeString()}
          </div>
          <div style="font-size:11px;color:#4CAF50;margin-top:2px;">
            Confianza: ${data.confidence}%
          </div>
          ${data.total_detections ? `<div style="font-size:10px;color:#666;margin-top:4px;">
            Total: ${data.total_detections} | Confirmados: ${data.confirmed_count}
          </div>` : ''}
        </div>
        <div style="margin-left:15px;">
          <div style="width:60px;height:60px;border-radius:50%;background:#E53935;display:flex;align-items:center;justify-content:center;font-size:24px;animation:pulse 1s infinite;">‚ö†Ô∏è</div>
        </div>
      </div>
    `;
    
    feed.insertBefore(item, feed.firstChild);
    
    while (feed.children.length > 20) {
      feed.removeChild(feed.lastChild);
    }
  }

  function playAlertSound() {
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
    } catch (e) {
      console.warn('No se pudo reproducir sonido:', e);
    }
  }

  function showDesktopNotification(data) {
    if ("Notification" in window && Notification.permission === "granted") {
      new Notification("üö® ACCIDENTE DETECTADO", {
        body: `C√°mara ${data.camera_ip}\nConfianza: ${data.confidence}%\nHora: ${new Date(data.timestamp).toLocaleTimeString()}`,
        tag: `accident-${data.camera_id}`,
        requireInteraction: true
      });
    }
  }

  function updateGlobalStats() {
    let totalDetections = 0;
    let totalConfirmed = 0;
    
    const promises = cameras.map(cam => {
      if (cam.is_streaming) {
        return loadCameraStats(cam.id).then(stats => {
          if (stats) {
            totalDetections += stats.total_detections;
            totalConfirmed += stats.confirmed_accidents;
          }
        });
      }
      return Promise.resolve();
    });
    
    Promise.all(promises).then(() => {
      const totalEl = document.getElementById('global-total-detections');
      const confirmedEl = document.getElementById('global-confirmed-accidents');
      
      if (totalEl) totalEl.innerText = totalDetections;
      if (confirmedEl) confirmedEl.innerText = totalConfirmed;
    });
  }

  async function loadCameraStats(cameraId) {
    try {
      const response = await fetch(`${API_URL}/cameras/${cameraId}/stats`);
      const data = await response.json();
      
      if (data.success) {
        return data.stats;
      }
    } catch (error) {
      console.error('Error cargando estad√≠sticas:', error);
    }
    return null;
  }

  // Actualizar estad√≠sticas cada 5 segundos
  setInterval(updateGlobalStats, 5000);

  // Solicitar permiso para notificaciones
  window.addEventListener('load', () => {
    if ("Notification" in window && Notification.permission === "default") {
      Notification.requestPermission();
    }
  });

  function updateChartsWithNewDetection(data) {
    // Placeholder para actualizar gr√°ficas en tiempo real
    console.log('Actualizando gr√°ficas con nueva detecci√≥n:', data);
  }

  // ============================================
// RECEPCI√ìN DE FRAMES DE C√ÅMARA
// ============================================
  socket.on('camera_frame', function(data) {
  if (!data || !data.frame) {
    console.warn('‚ö†Ô∏è Frame vac√≠o');
    return;
  }
  
  console.log('üìπ Frame recibido de c√°mara', data.camera_id, '- Tama√±o:', data.frame.length);
  
  const cameraId = data.camera_id.toString(); // Asegurar que es string
  const frameData = 'data:image/jpeg;base64,' + data.frame;
  
  // 1Ô∏è‚É£ Actualizar preview en p√°gina "C√°maras"
  const previewImg = document.getElementById('cam-preview-' + cameraId);
  if (previewImg) {
    previewImg.src = frameData;
    previewImg.style.display = 'block';
    console.log('‚úÖ Preview actualizado para c√°mara', cameraId);
  } else {
    console.warn('‚ö†Ô∏è Preview no encontrado para c√°mara', cameraId);
  }
  
  // 2Ô∏è‚É£ Actualizar "Monitoreo DVR"
  const dvrImg = document.getElementById('dvr-stream-' + cameraId);
  const waiting = document.getElementById('dvr-waiting-' + cameraId);
  const statsDiv = document.getElementById('dvr-stats-' + cameraId);

  if (dvrImg) {
    dvrImg.src = frameData;
    dvrImg.style.display = 'block';
    
    if (waiting) waiting.style.display = 'none';
    
    if (data.yolo_active && statsDiv) {
      statsDiv.style.display = 'block';
    }
    console.log('‚úÖ DVR actualizado para c√°mara', cameraId);
  } else {
    console.warn('‚ö†Ô∏è DVR img no encontrada para c√°mara', cameraId);
  }
  
  // 3Ô∏è‚É£ Actualizar indicadores en DVR
  const cell = document.querySelector('.dvr-cell[data-camera-id="' + cameraId + '"]');
  if (cell) {
    if (data.consecutive_detections > 0) {
      cell.dataset.detecting = 'true';
      cell.style.borderColor = '#FF9800';
      cell.style.borderWidth = '4px';
      cell.style.boxShadow = '0 0 20px rgba(255, 152, 0, 0.6)';
      
      const detectingOverlay = document.getElementById(`dvr-detecting-${cameraId}`);
      if (detectingOverlay) {
        detectingOverlay.style.display = 'block';
        detectingOverlay.innerHTML = `
          ‚ö†Ô∏è VERIFICANDO ACCIDENTE<br>
          <small style="font-size:11px;font-weight:normal;">
            ${data.consecutive_detections}/${data.detection_progress || 25} frames
          </small>
        `;
      }
    } else {
      cell.dataset.detecting = 'false';
      cell.style.borderColor = data.yolo_active ? '#4CAF50' : '#444';
      cell.style.borderWidth = '2px';
      cell.style.boxShadow = '';
      
      const detectingOverlay = document.getElementById(`dvr-detecting-${cameraId}`);
      if (detectingOverlay) {
        detectingOverlay.style.display = 'none';
      }
    }
    
    const consecutiveSpan = document.getElementById(`dvr-consecutive-${cameraId}`);
    if (consecutiveSpan) {
      consecutiveSpan.innerText = data.consecutive_detections || 0;
    }
  }
});



  // ============================================
  // FUNCIONES DE CARGA DE DATOS REALES
  // ============================================

  async function loadAllData() {
    await loadCameras();
    await loadAccidents();
    await loadUsers();
    updateDashboard();
  }

  async function loadCameras() {
    try {
      const response = await fetch(`${API_URL}/cameras`);
      const data = await response.json();
      
      if (data.success) {
        cameras = data.cameras;
        updateCameraCount();
        renderCameras();
      }
    } catch (error) {
      console.error('Error cargando c√°maras:', error);
      showToast('Error cargando c√°maras', 'error');
    }
  }

  async function loadAccidents() {
    try {
      const response = await fetch(`${API_URL}/accidents?limit=100`);
      const data = await response.json();
      
      if (data.success) {
        accidents = data.accidents;
        renderRegistros();
        updateDashboard();
      }
    } catch (error) {
      console.error('Error cargando accidentes:', error);
      showToast('Error cargando accidentes', 'error');
    }
  }

  async function loadUsers() {
    try {
      const response = await fetch(`${API_URL}/users`);
      const data = await response.json();
      
      if (data.success) {
        users = data.users;
        renderUsers();
      }
    } catch (error) {
      console.error('Error cargando usuarios:', error);
    }
  }
 // ============================================
  // NAVEGACI√ìN
  // ============================================
  function showPage(pageId) {
    // ‚úÖ Detener actualizaciones de config si sales de monitoreo
    if (pageId !== 'monitoreo') {
      stopLiveConfigUpdates();
    }
    
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.menu-button').forEach(b => b.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    event.target.classList.add('active');
    
    if (pageId === 'camaras') loadCameras();
    if (pageId === 'agregar') {
      setTimeout(() => {
        initMap();
        if (map) map.invalidateSize();
      }, 100);
    }
    if (pageId === 'monitoreo') {
      initDVR();
      setTimeout(() => {
        updateGlobalStats();
        startLiveConfigUpdates(); // ‚úÖ Iniciar actualizaciones autom√°ticas
      }, 500);
    }
    if (pageId === 'registros') loadAccidents();
    if (pageId === 'estadisticas') initCharts();
    if (pageId === 'dashboard') updateDashboard();
    if (pageId === 'usuarios') loadUsers();
    if (pageId === 'mapa') {
      initMainMap();
    } // ‚úÖ FALTABA ESTE CIERRE
    if (pageId === 'reportes') {
      setTimeout(() => {
        // Establecer fechas por defecto (√∫ltimo mes)
        const today = new Date();
        const lastMonth = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
        
        document.getElementById('report-start-date').value = lastMonth.toISOString().split('T')[0];
        document.getElementById('report-end-date').value = today.toISOString().split('T')[0];
        
        showReportTab('audit');
      }, 100);
    }
    if (pageId === 'config') {
      setTimeout(() => loadConfig(), 100);
    }
  }
  

  function logout() {
  if (confirm('¬øDesea cerrar sesi√≥n?')) {
    // üîπ Borra todos los datos de sesi√≥n
    localStorage.removeItem('session');
    sessionStorage.removeItem('session');
    sessionStorage.removeItem('permissions');

    showToast('Sesi√≥n cerrada', 'success');

    // üîπ Redirige al login despu√©s de un segundo
    setTimeout(() => {
      window.location.href = 'login.html';
    }, 1000);
  }
}

function showAllCameras() {
  if (mainMap === null) {
    initMainMap();
    setTimeout(showAllCameras, 500);
    return;
  }
  
  // Limpiar marcadores anteriores
  mainMap.eachLayer(layer => {
    if (layer instanceof L.Marker) {
      mainMap.removeLayer(layer);
    }
  });
  
  if (cameras.length === 0) {
    showToast('No hay c√°maras registradas', 'warning');
    return;
  }
  
  // Agregar marcador por cada c√°mara
  cameras.forEach(cam => {
    if (cam.latitud && cam.longitud) {
      const marker = L.marker([cam.latitud, cam.longitud]).addTo(mainMap);
      marker.bindPopup(`
        <div style="color:#000;">
          <strong>C√°mara ${cam.id}</strong><br>
          IP: ${cam.ip}:${cam.puerto}<br>
          Estado: ${cam.is_streaming ? 'üü¢ Activa' : '‚ö´ Inactiva'}
        </div>
      `);
    }
  });
  
  // Centrar mapa en la primera c√°mara
  if (cameras[0] && cameras[0].latitud && cameras[0].longitud) {
    mainMap.setView([cameras[0].latitud, cameras[0].longitud], 13);
  }
  
  showToast(`${cameras.length} c√°maras mostradas en el mapa`, 'success');
}
  // ============================================
  // MAPA LEAFLET
  // ============================================
  function initMap() {
    if (map !== null) return;
    
    const defaultLat = 4.6097;
    const defaultLng = -74.0817;
    
    map = L.map('mapContainer').setView([defaultLat, defaultLng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap',
      maxZoom: 19
    }).addTo(map);
    
    map.on('click', function(e) {
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;
      
      document.getElementById('camLat').value = lat.toFixed(6);
      document.getElementById('camLng').value = lng.toFixed(6);
      
      if (marker !== null) {
        map.removeLayer(marker);
      }
      
      marker = L.marker([lat, lng]).addTo(map);
      showToast(`Ubicaci√≥n seleccionada: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'success');
    });
  }

  function useMyLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        
        map.setView([lat, lng], 15);
        
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
        
        document.getElementById('camLat').value = lat.toFixed(6);
        document.getElementById('camLng').value = lng.toFixed(6);
        
        showToast('Ubicaci√≥n actual obtenida', 'success');
      }, function() {
        showToast('No se pudo obtener la ubicaci√≥n', 'error');
      });
    }
  }

  // ============================================
  // C√ÅMARAS
  // ============================================

  async function addCamera() {
    const ip = document.getElementById('camIP').value;
    const puerto = document.getElementById('camPort').value || '554';
    const usuario = document.getElementById('camUser').value || 'admin';
    const password = document.getElementById('camPass').value || '';
    const latitud = parseFloat(document.getElementById('camLat').value);
    const longitud = parseFloat(document.getElementById('camLng').value);
    
    if (!ip || !latitud || !longitud) {
      showToast('Complete IP, Latitud y Longitud (seleccione en el mapa)', 'error');
      return;
    }
    
    const data = {
      ip: ip,
      puerto: puerto,
      usuario: usuario,
      password: password,
      latitud: latitud,
      longitud: longitud,
      url_rtsp: `rtsp://${usuario}:${password}@${ip}:${puerto}/Streaming/Channels/101`
    };
    
    try {
      const response = await fetch(`${API_URL}/cameras`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (result.success) {
        showToast('C√°mara agregada correctamente', 'success');
        
        document.getElementById('camIP').value = '';
        document.getElementById('camPort').value = '554';
        document.getElementById('camUser').value = 'admin';
        document.getElementById('camPass').value = '';
        document.getElementById('camLat').value = '';
        document.getElementById('camLng').value = '';
        
        if (marker) {
          map.removeLayer(marker);
          marker = null;
        }
        
        loadCameras();
        showPage('camaras');
      } else {
        showToast('Error: ' + result.error, 'error');
      }
    } catch (error) {
      showToast('Error conectando con el servidor', 'error');
    }
  }

  async function deleteCamera(id) {
    if (!confirm('¬øEliminar esta c√°mara?')) return;
    
    try {
      const response = await fetch(`${API_URL}/cameras/${id}`, {
        method: 'DELETE'
      });
      
      const result = await response.json();
      
      if (result.success) {
        showToast('C√°mara eliminada', 'success');
        loadCameras();
      }
    } catch (error) {
      showToast('Error eliminando c√°mara', 'error');
    }
  }

  function renderCameras() {
    const list = document.getElementById("cameraList");
    list.innerHTML = "";
    
    if (cameras.length === 0) {
      list.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;padding:40px;">No hay c√°maras registradas. Agrega una desde el men√∫.</div>';
      return;
    }
    
    cameras.forEach(cam => {
      const card = document.createElement("div");
      card.className = "camera-card";
      
      let previewContent = `<div style="font-size:48px;">üìπ</div>`;
      
      if (cam.is_streaming) {
        previewContent = `
          <img id="cam-preview-${cam.id}" style="width:100%;height:100%;object-fit:cover;" alt="Stream en vivo">
          <div style="position:absolute;top:10px;right:10px;background:rgba(76,175,80,0.9);padding:4px 8px;border-radius:4px;font-size:10px;font-weight:bold;">
            üéØ YOLO ACTIVO
          </div>
        `;
      }
      
      card.innerHTML = `
        <div class="camera-preview" style="position:relative;">${previewContent}</div>
        <div style="margin-bottom:8px;"><b>C√°mara ${cam.id}</b></div>
        <div style="font-size:12px;color:#999;margin-bottom:4px;">IP: ${cam.ip}:${cam.puerto}</div>
        <div style="font-size:12px;color:#999;margin-bottom:4px;">üìç ${cam.latitud != null ? parseFloat(cam.latitud).toFixed(6) : 'N/A'}, ${cam.longitud != null ? parseFloat(cam.longitud).toFixed(6) : 'N/A'}</div>
        <div style="font-size:12px;margin-bottom:10px;">
          <span style="color:${cam.is_streaming ? '#4CAF50' : '#999'};">‚óè ${cam.is_streaming ? 'Transmitiendo' : 'Detenida'}</span>
        </div>
        <div id="cam-stats-${cam.id}" style="font-size:10px;color:#666;margin-bottom:8px;min-height:20px;"></div>
        <button class="btn ${cam.is_streaming ? 'btn-danger' : 'btn-success'}" 
                onclick="${cam.is_streaming ? 'stopCameraStream' : 'startCameraStream'}(${cam.id})" 
                style="font-size:12px;padding:6px 12px;margin-right:5px;">
          ${cam.is_streaming ? '‚èπÔ∏è Detener' : '‚ñ∂Ô∏è Iniciar'}
        </button>
        <button class="btn btn-danger" onclick="deleteCamera(${cam.id})" style="font-size:12px;padding:6px 12px;">üóëÔ∏è Eliminar</button>
      `;
      list.appendChild(card);
      
      if (cam.is_streaming) {
        loadCameraStats(cam.id).then(stats => {
          if (stats) {
            const statsDiv = document.getElementById(`cam-stats-${cam.id}`);
            if (statsDiv) {
              statsDiv.innerHTML = `
                üìä Detecciones: ${stats.total_detections} | 
                ‚úÖ Confirmados: ${stats.confirmed_accidents}
              `;
            }
          }
        });
      }
    });
    
    updateCameraCount();
  }

  function updateCameraCount() {
    const total = cameras.length;
    const active = cameras.filter(c => c.is_streaming).length;
    
    document.getElementById("cameras-online").innerText = `${active}/${total}`;
    document.getElementById("dash-cams").innerText = total;
  }

  // ============================================
  // MONITOREO DVR
  // ============================================

  function initDVR() {
    renderDVRGrid();
  }

  function setDVRGrid(num) {
    currentGrid = num;
    renderDVRGrid();
  }

  function renderDVRGrid() {
    const grid = document.getElementById('dvrGrid');
    grid.className = `dvr-grid grid-${currentGrid}`;
    grid.innerHTML = '';
  
    for (let i = 0; i < currentGrid; i++) {
      const cell = document.createElement('div');
      cell.className = 'dvr-cell';
      cell.dataset.cameraId = cameras[i]?.id || '';
    
      if (i < cameras.length) {
        const cam = cameras[i];
        
        if (cam.is_streaming) {
          cell.dataset.yoloActive = 'true';
        }
      
        cell.addEventListener('dblclick', function() {
          toggleFullscreen(this);
        });
      
        cell.innerHTML = `
          <div class="dvr-label" style="background:rgba(0,0,0,0.8);padding:8px 12px;border-radius:6px;">
            C√°mara ${cam.id} - ${cam.ip}
            ${cam.is_streaming ? '<span style="color:#4CAF50;margin-left:8px;">üéØ YOLO</span>' : ''}
          </div>
          <img id="dvr-stream-${cam.id}" style="width:100%;height:100%;object-fit:cover;display:none;" alt="Stream">
          <div id="dvr-waiting-${cam.id}" style="color:#999;padding:20px;text-align:center;">
            Esperando stream...
            ${cam.is_streaming ? '<br><small style="color:#4CAF50;">Conectando...</small>' : ''}
          </div>
          
          <div id="dvr-stats-${cam.id}" style="position:absolute;bottom:50px;left:10px;background:rgba(0,0,0,0.85);padding:8px 12px;border-radius:6px;font-size:11px;display:none;z-index:20;">
            <div style="color:#4CAF50;font-weight:bold;">üìä Estad√≠sticas YOLO</div>
            <div style="color:#ccc;margin-top:4px;">Detecciones: <span id="dvr-detections-${cam.id}">0</span></div>
            <div style="color:#ccc;">Confirmados: <span id="dvr-confirmed-${cam.id}">0</span></div>
            <div style="color:#FF9800;margin-top:4px;">Consecutivos: <span id="dvr-consecutive-${cam.id}">0</span>/<span id="dvr-required-${cam.id}">25</span></div>
          </div>
          
          <div id="dvr-detecting-${cam.id}" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,152,0,0.95);padding:15px 25px;border-radius:10px;font-size:14px;font-weight:bold;display:none;z-index:30;animation:pulse 1s infinite;">
            ‚ö†Ô∏è VERIFICANDO ACCIDENTE
          </div>
          
          <div style="position:absolute;bottom:10px;left:10px;z-index:10;">
            <button class="btn btn-success" onclick="startCameraStream(${cam.id}); event.stopPropagation();" style="font-size:10px;padding:4px 8px;">‚ñ∂Ô∏è</button>
            <button class="btn btn-danger" onclick="stopCameraStream(${cam.id}); event.stopPropagation();" style="font-size:10px;padding:4px 8px;">‚èπÔ∏è</button>
          </div>
        `;
      } else {
        cell.innerHTML = '<div style="color:#666;">Sin c√°mara asignada</div>';
      }
    
      grid.appendChild(cell);
    }
    
    startDVRStatsUpdate();
  }

  async function startCameraStream(cameraId) {
    try {
      const response = await fetch(`${API_URL}/cameras/${cameraId}/start`, {
        method: 'POST'
      });
      
      const result = await response.json();
      
      if (result.success) {
        showToast('Stream iniciado', 'success');
        loadCameras();
      } else {
        showToast('Error iniciando stream', 'error');
      }
    } catch (error) {
      showToast('Error conectando con el servidor', 'error');
    }
  }

  async function stopCameraStream(cameraId) {
    try {
      const response = await fetch(`${API_URL}/cameras/${cameraId}/stop`, {
        method: 'POST'
      });
      
      const result = await response.json();
      
      if (result.success) {
        showToast('Stream detenido', 'success');
        loadCameras();
      }
    } catch (error) {
      showToast('Error deteniendo stream', 'error');
    }
  }

  let fullscreenCell = null;

  function toggleFullscreen(cell) {
    if (fullscreenCell) {
      fullscreenCell.classList.remove('fullscreen');
      fullscreenCell = null;
      setTimeout(() => renderDVRGrid(), 100);
      showToast('Saliendo de pantalla completa', 'info');
      return;
    }
  
    cell.classList.add('fullscreen');
    fullscreenCell = cell;
  
    const buttons = cell.querySelector('[style*="position:absolute"]');
    if (buttons) {
      buttons.style.display = 'none';
    }
  
    showToast('Doble click nuevamente o presiona ESC para salir', 'info');
  
    const escapeHandler = (e) => {
      if (e.key === 'Escape' && fullscreenCell) {
        toggleFullscreen(fullscreenCell);
        document.removeEventListener('keydown', escapeHandler);
      }
    };
  
    document.addEventListener('keydown', escapeHandler);
  }

  let dvrStatsInterval = null;

  function startDVRStatsUpdate() {
    if (dvrStatsInterval) {
      clearInterval(dvrStatsInterval);
    }
    
    dvrStatsInterval = setInterval(() => {
      cameras.forEach(cam => {
        if (cam.is_streaming) {
          loadCameraStats(cam.id).then(stats => {
            if (stats) {
              const detectionsSpan = document.getElementById(`dvr-detections-${cam.id}`);
              const confirmedSpan = document.getElementById(`dvr-confirmed-${cam.id}`);
              
              if (detectionsSpan) detectionsSpan.innerText = stats.total_detections;
              if (confirmedSpan) confirmedSpan.innerText = stats.confirmed_accidents;
            }
          });
        }
      });
    }, 3000);
  }

// ============================================
// REGISTROS
// ============================================

function renderRegistros() {
  const table = document.getElementById('registrosTable');
  table.innerHTML = '';

  if (accidents.length === 0) {
    table.innerHTML = `
      <tr>
        <td colspan="8" style="text-align:center;color:#999;">
          No hay registros de accidentes
        </td>
      </tr>`;
    return;
  }

  accidents.forEach(acc => {
    const fecha = new Date(acc.fecha_accidente);
    const fechaAjustada = new Date(fecha.getTime() + (5 * 60 * 60 * 1000));
    const fechaLocal = fechaAjustada.toLocaleDateString('es-CO', { timeZone: 'America/Bogota' });
    const horaLocal = fechaAjustada.toLocaleTimeString('es-CO', { timeZone: 'America/Bogota' });

    const tr = document.createElement('tr');
    const nombreVideo = acc.ruta_archivo ? acc.ruta_archivo.split('\\').pop() : 'N/A';
    
    tr.innerHTML = `
      <td>${acc.id}</td>
      <td>${fechaLocal}</td>
      <td>${horaLocal}</td>
      <td>${nombreVideo}</td>
      <td>${acc.camera_ip || 'C√°mara ' + acc.id_camara}</td>
      <td>${acc.latitud}, ${acc.longitud}</td>
      <td>
        <button class="btn btn-primary" onclick="viewAccident(${acc.id})" style="font-size:11px;padding:4px 8px;">üëÅÔ∏è Ver</button>
        ${acc.ruta_archivo ? `<button class="btn btn-warning" onclick="playVideo('${nombreVideo}')" style="font-size:11px;padding:4px 8px;margin-left:4px;">‚ñ∂Ô∏è Video</button>` : ''}
      </td>
    `;
    table.appendChild(tr);
  });

  document.getElementById("dash-accidents").innerText = accidents.length;
}

function playVideo(filename) {
  console.log('Intentando reproducir:', filename);
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  `;

  const videoContainer = document.createElement('div');
  videoContainer.style.cssText = `
    position: relative;
    max-width: 90%;
    max-height: 90%;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
  `;

  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '√ó';
  closeBtn.style.cssText = `
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.7);
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 4px;
    z-index: 2001;
  `;
  closeBtn.onclick = () => modal.remove();

  const video = document.createElement('video');
  video.style.cssText = `
    width: 100%;
    max-width: 900px;
    max-height: 80vh;
    display: block;
  `;
  video.controls = true;
  video.autoplay = false; // No autoplay para evitar errores
  
  // Construir URL correctamente
  const videoUrl = `https://accident-detector.site/videos/${encodeURIComponent(filename)}`;
  console.log('URL del video:', videoUrl);
  
  video.src = videoUrl;
  
  // Log de eventos del video
  video.addEventListener('loadstart', () => console.log('Video: loadstart'));
  video.addEventListener('loadedmetadata', () => console.log('Video: loadedmetadata'));
  video.addEventListener('canplay', () => {
    console.log('Video: canplay');
    showToast('Video listo para reproducir', 'success');
  });
  video.addEventListener('error', (e) => {
    console.error('Video error:', e);
    showToast('Error al cargar video', 'error');
  });

  videoContainer.appendChild(closeBtn);
  videoContainer.appendChild(video);
  modal.appendChild(videoContainer);

  modal.onclick = (e) => {
    if (e.target === modal) modal.remove();
  };

  document.body.appendChild(modal);
  showToast('Cargando video...', 'info');
}


function viewAccident(id) {
  const acc = accidents.find(a => a.id === id);
  if (!acc) return;

  const fecha = new Date(acc.fecha_accidente);
  const fechaLocal = fecha.toLocaleDateString('es-CO', {
    timeZone: 'America/Bogota'
  });
  const horaLocal = fecha.toLocaleTimeString('es-CO', {
    timeZone: 'America/Bogota'
  });

  let mensaje = `
ACCIDENTE #${acc.id}

Fecha: ${fechaLocal}
Hora: ${horaLocal}
C√°mara: ${acc.camera_ip || 'ID ' + acc.id_camara}
Ubicaci√≥n: ${acc.latitud}, ${acc.longitud}
Descripci√≥n: ${acc.descripcion || 'N/A'}
Archivo: ${acc.ruta_archivo ? acc.ruta_archivo.split('\\').pop() : 'N/A'}`;

  alert(mensaje);

  if (acc.ruta_archivo) {
    if (confirm('¬øDeseas reproducir el video del accidente?')) {
      playVideo(acc.ruta_archivo.split('\\').pop());
    }
  }
}

async function exportToCSV() {
  try {
    const response = await fetch(`${API_URL}/accidents/export`);
    
    if (response.ok) {
      const csv = await response.text();
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `accidentes_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      
      showToast('CSV exportado correctamente', 'success');
    }
  } catch (error) {
    showToast('Error exportando CSV', 'error');
  }
}


  // ============================================
  // SUBIR VIDEO
  // ============================================

  let currentVideo = null;
  let analysisData = [];

  function previewVideo(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    currentVideo = file;
    const url = URL.createObjectURL(file);
    const video = document.getElementById("videoPreview");
    video.src = url;
    video.style.display = 'block';
    document.getElementById('analyzeBtn').disabled = false;
    
    showToast('Video cargado, listo para analizar', 'success');
  }

  async function analyzeVideo() {
    if (!currentVideo) return;
    
    const formData = new FormData();
    formData.append('video', currentVideo);
    
    showToast('Subiendo video...', 'info');
    document.getElementById('analyzeBtn').disabled = true;
    document.getElementById('analyzeBtn').innerText = '‚è≥ Subiendo...';
    
    try {
      const uploadResponse = await fetch(`${API_URL}/videos/upload`, {
        method: 'POST',
        body: formData
      });
      
      const uploadResult = await uploadResponse.json();
      
      if (!uploadResult.success) {
        throw new Error(uploadResult.error);
      }
      
      showToast('Analizando video con YOLO...', 'info');
      document.getElementById('analyzeBtn').innerText = '‚è≥ Analizando...';
      
      const analyzeResponse = await fetch(`${API_URL}/videos/analyze`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          video_path: uploadResult.video_path,
          filename: uploadResult.filename
        })
      });
      
      const analyzeResult = await analyzeResponse.json();
      
      if (analyzeResult.success) {
        analysisData = analyzeResult.analysis.detections;
        displayAnalysisResults();
        
        showToast(`An√°lisis completado: ${analysisData.length} detecciones SEVERE`, 'success');
        
        window.currentReportPath = analyzeResult.analysis.report_path;
        window.currentAnnotatedVideoPath = analyzeResult.analysis.annotated_video_path;
      } else {
        throw new Error(analyzeResult.error);
      }
      
    } catch (error) {
      showToast('Error: ' + error.message, 'error');
    } finally {
      document.getElementById('analyzeBtn').disabled = false;
      document.getElementById('analyzeBtn').innerText = 'üîç Analizar Video';
    }
  }

function displayAnalysisResults() {
  const container = document.getElementById('analysisResults');
  const list = document.getElementById('detectionsList');
  
  list.innerHTML = '<div style="font-weight:bold;margin-bottom:10px;">Detecciones SEVERE Encontradas:</div>';
  
  if (analysisData.length === 0) {
    list.innerHTML += '<div style="color:#999;">No se detectaron accidentes SEVERE en el video</div>';
  } else {
    analysisData.forEach((det, idx) => {
      const item = document.createElement('div');
      item.className = 'detection-result';
      
      let framePreview = '';
      if (det.frame_path) {
        const frameName = det.frame_path.split(/[\\/]/).pop();
        const frameDir = det.frame_path.split(/[\\/]/).slice(-2, -1)[0];
        framePreview = `<img src="${API_URL}/videos/frame/${frameDir}/${frameName}" style="width:100%;max-width:400px;margin-top:10px;border-radius:6px;" alt="Frame ${det.frame}">`;
      }
      
      item.innerHTML = `
        <div style="display:flex;justify-content:space-between;">
          <div><strong>Detecci√≥n ${idx + 1}:</strong> ACCIDENTE SEVERE</div>
          <div style="color:#4CAF50;">Confianza: ${(det.confidence * 100).toFixed(1)}%</div>
        </div>
        <div style="font-size:12px;color:#999;margin-top:4px;">‚è±Ô∏è ${det.timestamp} (Frame: ${det.frame})</div>
        ${framePreview}
      `;
      list.appendChild(item);
    });
    
    if (window.currentAnnotatedVideoPath) {
      const downloadBtn = document.createElement('button');
      downloadBtn.className = 'btn btn-success';
      downloadBtn.style.marginTop = '15px';
      downloadBtn.innerHTML = 'üé¨ Descargar Video Anotado';
      downloadBtn.onclick = downloadAnnotatedVideo;
      list.appendChild(downloadBtn);
    }
  }
  
  container.style.display = 'block';
}

async function downloadAnnotatedVideo() {
  if (!window.currentAnnotatedVideoPath) {
    showToast('No hay video anotado disponible', 'warning');
    return;
  }
  
  try {
    const response = await fetch(`${API_URL}/videos/download-annotated`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        video_path: window.currentAnnotatedVideoPath
      })
    });
    
    if (response.ok) {
      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'video_anotado_' + new Date().getTime() + '.mp4';
      a.click();
      
      showToast('Video anotado descargado', 'success');
    }
  } catch (error) {
    showToast('Error descargando video', 'error');
  }
}

  function downloadResults() {
    downloadAnnotatedVideo();
  }
// ============================================
// üìä ESTAD√çSTICAS COMPLETAS
// ============================================

// =========================
//  VARIABLES GLOBALES
// =========================

let charts = {
    hour: null,
    day: null,
    month: null
};

async function initCharts() {
  try {
    const session = getSession();
    const response = await fetch(`${API_URL}/accidents?limit=1000`, {
      headers: { 'Authorization': `Bearer ${session.token}` }
    });
    const data = await response.json();
    if (data.success) {
      updateStatsSummary(data.accidents);
      createHourChart(data.accidents);
      createSeverityChart(data.accidents);
      createCameraChart(data.accidents);
      createWeeklyChart(data.accidents);
    }
  } catch (error) {
    console.error('Error stats:', error);
  }
}

function updateStatsSummary(accidents) {
  document.getElementById('stat-total-accidents').innerText = accidents.length;
  document.getElementById('stat-cameras-active').innerText = cameras.filter(c => c.is_streaming).length;
  const now = new Date();
  const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
  document.getElementById('stat-last-24h').innerText = accidents.filter(a => new Date(a.fecha_accidente) > yesterday).length;
  if (accidents.length > 0) {
    const first = new Date(accidents[accidents.length - 1].fecha_accidente);
    const last = new Date(accidents[0].fecha_accidente);
    const days = Math.max(1, Math.ceil((last - first) / (1000 * 60 * 60 * 24)));
    document.getElementById('stat-avg-per-day').innerText = (accidents.length / days).toFixed(1);
  }
}

function createHourChart(accidents) {
  const ctx = document.getElementById('hourChart').getContext('2d');
  if (charts.hour) charts.hour.destroy();
  const hourData = new Array(24).fill(0);
  accidents.forEach(acc => hourData[new Date(acc.fecha_accidente).getHours()]++);
  const avg = hourData.reduce((a, b) => a + b, 0) / 24;
  charts.hour = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [...Array(24).keys()].map(h => `${String(h).padStart(2, '0')}:00`),
      datasets: [{
        label: 'Accidentes',
        data: hourData,
        borderColor: '#42A5F5',
        backgroundColor: 'rgba(66,165,245,0.2)',
        fill: true,
        tension: 0.4
      }, {
        label: 'Promedio',
        data: new Array(24).fill(avg),
        borderColor: '#FFB300',
        borderDash: [8, 5],
        borderWidth: 2,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#E0E0E0' } } },
      scales: {
        x: { ticks: { color: '#E0E0E0' }, grid: { color: '#444' } },
        y: { ticks: { color: '#E0E0E0' }, grid: { color: '#444' }, beginAtZero: true }
      }
    }
  });
}

function createSeverityChart(accidents) {
  const ctx = document.getElementById('severityChart').getContext('2d');
  if (charts.severity) charts.severity.destroy();
  const severityData = { 'BAJA': 0, 'MEDIA': 0, 'ALTA': 0, 'CR√çTICA': 0 };
  accidents.forEach(acc => { if (severityData[acc.severidad] !== undefined) severityData[acc.severidad]++; });
  const data = Object.values(severityData);
  const total = data.reduce((a, b) => a + b, 0);
  const colors = ['#4CAF50', '#FF9800', '#E53935', '#B71C1C'];
  charts.severity = new Chart(ctx, {
    type: 'doughnut',
    data: { labels: Object.keys(severityData), datasets: [{ data: data, backgroundColor: colors, borderWidth: 2, borderColor: '#252526' }] },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
  const legend = document.getElementById('severity-legend');
  legend.innerHTML = Object.keys(severityData).map((label, i) => {
    const percent = total > 0 ? ((data[i] / total) * 100).toFixed(1) : 0;
    return `<div style="display:flex;align-items:center;gap:15px;padding:12px;background:#1E1E1E;border-radius:8px;border-left:4px solid ${colors[i]};"><div style="width:50px;height:50px;background:${colors[i]};border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:bold;color:#FFF;">${data[i]}</div><div style="flex:1;"><div style="font-weight:bold;color:${colors[i]};font-size:16px;">${label}</div><div style="color:#999;font-size:12px;">${percent}% del total</div></div></div>`;
  }).join('');
}

function createCameraChart(accidents) {
  const ctx = document.getElementById('cameraChart').getContext('2d');
  if (charts.camera) charts.camera.destroy();
  const cameraData = {};
  accidents.forEach(acc => { const camIP = acc.camera_ip || `C√°mara ${acc.id_camara}`; cameraData[camIP] = (cameraData[camIP] || 0) + 1; });
  const sorted = Object.entries(cameraData).sort((a, b) => b[1] - a[1]).slice(0, 10);
  const data = sorted.map(([_, count]) => count);
  charts.camera = new Chart(ctx, {
    type: 'bar',
    data: { labels: sorted.map(([ip]) => ip), datasets: [{ label: 'Accidentes', data: data, backgroundColor: data.map(v => v > 50 ? '#E53935' : v > 20 ? '#FB8C00' : v > 10 ? '#FFB300' : '#43A047'), borderRadius: 6 }] },
    options: {
      responsive: true,
      indexAxis: 'y',
      plugins: { legend: { display: false } },
      scales: { x: { ticks: { color: '#E0E0E0' }, grid: { color: '#444' }, beginAtZero: true }, y: { ticks: { color: '#E0E0E0' }, grid: { color: '#444' } } }
    }
  });
}

function createWeeklyChart(accidents) {
  const ctx = document.getElementById('weeklyChart').getContext('2d');
  if (charts.weekly) charts.weekly.destroy();
  const last7Days = [];
  const today = new Date();
  for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    date.setHours(0, 0, 0, 0);
    last7Days.push(date);
  }
  const dailyData = last7Days.map(date => {
    const nextDay = new Date(date);
    nextDay.setDate(nextDay.getDate() + 1);
    return accidents.filter(acc => {
      const accDate = new Date(acc.fecha_accidente);
      return accDate >= date && accDate < nextDay;
    }).length;
  });
  charts.weekly = new Chart(ctx, {
    type: 'line',
    data: {
      labels: last7Days.map(d => `${d.toLocaleDateString('es-CO', { weekday: 'short' })} ${d.getDate()}`),
      datasets: [{ label: 'Accidentes', data: dailyData, borderColor: '#E53935', backgroundColor: 'rgba(229,57,53,0.2)', fill: true, tension: 0.4, pointBackgroundColor: '#C62828', pointRadius: 5, borderWidth: 3 }]
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#E0E0E0' } } },
      scales: { x: { ticks: { color: '#E0E0E0' }, grid: { color: '#444' } }, y: { ticks: { color: '#E0E0E0', stepSize: 1 }, grid: { color: '#444' }, beginAtZero: true } }
    }
  });
}
// ============================================
// üó∫Ô∏è MAPA DE CALOR + ACCIDENTES + C√ÅMARAS COMPLETO
// ============================================
let mainMap = null;
let heatmapLayer = null;
let camerasLayer = null;
let markersLayer = null;

// ---------------------------
// Inicializar mapa principal
// ---------------------------
function initMainMap() {
  if (mainMap !== null) return;

  const defaultLat = 4.6097;
  const defaultLng = -74.0817;

  mainMap = L.map("mapContainerMapa").setView([defaultLat, defaultLng], 13);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap contributors",
    maxZoom: 19
  }).addTo(mainMap);
}

// ============================================
// üìπ MOSTRAR TODAS LAS C√ÅMARAS
// ============================================
function showAllCameras() {
  if (!mainMap) {
    initMainMap();
    setTimeout(showAllCameras, 500);
    return;
  }

  // Limpiar capas anteriores
  clearMapMarkers();

  if (!cameras || cameras.length === 0) {
    showToast("No hay c√°maras registradas", "warning");
    updateMapStats(0, 0, 0);
    return;
  }

  camerasLayer = L.layerGroup();
  let validCameras = 0;

  cameras.forEach(cam => {
    const lat = parseFloat(cam.latitud);
    const lng = parseFloat(cam.longitud);

    if (!isNaN(lat) && !isNaN(lng)) {
      const marker = L.marker([lat, lng]);
      marker.bindPopup(`
        <div style="color:#000;">
          <strong>C√°mara ${cam.id || 'N/A'}</strong><br>
          IP: ${cam.ip || 'N/A'}:${cam.puerto || 'N/A'}<br>
          Estado: ${cam.is_streaming ? "üü¢ Activa" : "‚ö´ Inactiva"}
        </div>
      `);
      marker.addTo(camerasLayer);
      validCameras++;
    }
  });

  if (validCameras > 0) camerasLayer.addTo(mainMap);
  showToast(`${validCameras} c√°maras mostradas`, "success");
  updateMapStats(validCameras, 0, 0);

  // Centrar en la primera c√°mara
  if (validCameras > 0) {
    const firstCam = cameras.find(cam => !isNaN(parseFloat(cam.latitud)) && !isNaN(parseFloat(cam.longitud)));
    if (firstCam) mainMap.setView([parseFloat(firstCam.latitud), parseFloat(firstCam.longitud)], 13);
  }
}

// ============================================
// üö® MOSTRAR ACCIDENTES
// ============================================
function showAllAccidents() {
  if (!mainMap) {
    initMainMap();
    setTimeout(showAllAccidents, 500);
    return;
  }

  clearMapMarkers();

  if (!accidents || accidents.length === 0) {
    showToast("No hay accidentes registrados", "warning");
    updateMapStats(0, 0, 0);
    return;
  }

  markersLayer = L.layerGroup();
  let criticalCount = 0;
  let firstValidAccident = null;
  let validAccidents = 0;

  accidents.forEach(acc => {
    if (!acc) return;

    const lat = parseFloat(acc.latitud);
    const lng = parseFloat(acc.longitud);

    if (!isNaN(lat) && !isNaN(lng)) {
      if (!firstValidAccident) firstValidAccident = { lat, lng };

      const severidad = (acc.severidad || "BAJA").toUpperCase();
      const color = severidad === "CR√çTICA" || severidad === "CRITICA" ? "#B71C1C"
                  : severidad === "ALTA" ? "#E53935"
                  : severidad === "MEDIA" ? "#FF9800"
                  : "#4CAF50";

      if (severidad === "CR√çTICA" || severidad === "CRITICA") criticalCount++;

      const marker = L.circleMarker([lat, lng], {
        radius: 10,
        color: color,
        fillColor: color,
        fillOpacity: 0.9
      });
      marker.bindPopup(`
        <div style="color:black;font-weight:bold;">
          üö® Accidente ID: ${acc.id || 'N/A'}<br>
          Severidad: ${severidad}<br>
          Fecha: ${acc.fecha || 'N/A'}
        </div>
      `);
      marker.addTo(markersLayer);
      validAccidents++;
    }
  });

  if (validAccidents > 0) {
    markersLayer.addTo(mainMap);
    if (firstValidAccident) mainMap.setView([firstValidAccident.lat, firstValidAccident.lng], 13);
  }

  showToast(`${validAccidents} accidentes mostrados`, "success");
  updateMapStats(0, validAccidents, criticalCount);
}

// ============================================
// üî• MAPA DE CALOR TRANSPARENTE CON LOGS COMPLETOS
// ============================================
function toggleHeatmap1() {
  console.log("Bot√≥n presionado - toggleHeatmap ejecutado");

  if (!mainMap) {
    initMainMap();
    setTimeout(toggleHeatmap1, 500);
    return;
  }

  const info = document.getElementById("heatmapInfo");

  // Desactivar heatmap existente
  if (heatmapLayer) {
    mainMap.removeLayer(heatmapLayer);
    heatmapLayer = null;
    if (info) info.style.display = "none";
    showToast("Mapa de calor desactivado", "info");
    return;
  }

  clearMapMarkers();

  if (!accidents || accidents.length === 0) {
    showToast("No hay accidentes para el mapa de calor", "warning");
    return;
  }

  mainMap.whenReady(() => {
    console.log("üî• Configurando heatmap transparente sin fondo...");

    const heatData = [];
    let firstPoint = null;

    // Recorrer accidentes y filtrar coordenadas v√°lidas
    accidents.forEach(acc => {
      if (acc && acc.latitud && acc.longitud && !isNaN(acc.latitud) && !isNaN(acc.longitud)) {
        const lat = parseFloat(acc.latitud);
        const lng = parseFloat(acc.longitud);
        heatData.push([lat, lng, 1.0]);
        if (!firstPoint) firstPoint = { lat, lng };
      }
    });

    // Logs para depuraci√≥n
    console.log("accidents raw:", accidents);
    console.log("Cantidad total de accidentes:", accidents.length);
    console.log("üî• Datos filtrados para heatmap:", heatData);
    console.log("Cantidad de puntos v√°lidos:", heatData.length);

    if (heatData.length === 0) {
      showToast("No hay accidentes con coordenadas v√°lidas", "warning");
      return;
    }

    // Crear heatmap
    heatmapLayer = L.heatLayer(heatData, {
      radius: 70,
      blur: 45,
      maxZoom: 11,
      max: 1.0,
      minOpacity: 0.0,
      gradient: {
        0.0: "rgba(0,0,0,0)",
        0.2: "rgba(0,0,0,0)",
        0.4: "rgba(0,255,0,0.3)",
        0.6: "rgba(255,255,0,0.5)",
        0.8: "rgba(255,165,0,0.7)",
        1.0: "rgba(255,0,0,0.85)"
      }
    }).addTo(mainMap);

    // Forzar transparencia del canvas
    setTimeout(() => {
      const overlayPane = mainMap.getPanes().overlayPane;
      if (overlayPane) {
        const canvas = overlayPane.querySelector('canvas');
        if (canvas) {
          canvas.style.backgroundColor = "transparent";
          canvas.style.opacity = "1";
          console.log("‚úÖ Canvas transparente listo");
        }
        overlayPane.style.backgroundColor = "transparent";
      }
    }, 500);

    // Centrar mapa en primer punto v√°lido
    if (firstPoint) mainMap.setView([firstPoint.lat, firstPoint.lng], 13);

    // Mostrar info en pantalla
    if (info) {
      info.style.display = "block";
      info.innerHTML = `
        üî• Mapa de Calor Activo<br>
        üìç Puntos: ${heatData.length}<br>
        üî¥ Rojo = Mayor concentraci√≥n
      `;
    }

    showToast(`Mapa de calor activado (${heatData.length} puntos)`, "success");
  });
}

// ============================================
// üóëÔ∏è LIMPIAR TODO
// ============================================
function clearMapMarkers() {
  if (markersLayer) { markersLayer.clearLayers(); mainMap.removeLayer(markersLayer); markersLayer = null; }
  if (camerasLayer) { mainMap.removeLayer(camerasLayer); camerasLayer = null; }
  if (heatmapLayer) { mainMap.removeLayer(heatmapLayer); heatmapLayer = null; }
  const info = document.getElementById("heatmapInfo");
  if (info) info.style.display = "none";
  updateMapStats(0, 0, 0);
}

// ============================================
// üìä ACTUALIZAR ESTAD√çSTICAS
// ============================================
function updateMapStats(cameras, accidents, critical) {
  const camEl = document.getElementById("map-stat-cameras");
  const accEl = document.getElementById("map-stat-accidents");
  const critEl = document.getElementById("map-stat-critical");
  if (camEl) camEl.innerText = cameras || 0;
  if (accEl) accEl.innerText = accidents || 0;
  if (critEl) critEl.innerText = critical || 0;
}


  // ============================================
  // USUARIOS
  // ============================================

  function renderUsers() {
    const table = document.getElementById('usersTable');
    table.innerHTML = '';
    
    if (users.length === 0) {
      table.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;">No hay usuarios registrados</td></tr>';
      return;
    }
    
    users.forEach(user => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${user.id}</td>
        <td>${user.nombre}</td>
        <td>${user.correo}</td>
        <td>${user.rol}</td>
        <td><span style="color:#4CAF50;">Activo</span></td>
        <td>
          <button class="btn btn-danger" onclick="deleteUser(${user.id})" style="font-size:11px;padding:4px 8px;">üóëÔ∏è</button>
        </td>
      `;
      table.appendChild(tr);
    });
    
    document.getElementById("dash-users").innerText = users.length;
  }

  function openUserModal() {
    document.getElementById('userName').value = '';
    document.getElementById('userEmail').value = '';
    document.getElementById('userRole').value = 'operador';
    document.getElementById('userModal').classList.add('show');
  }

  function closeUserModal() {
    document.getElementById('userModal').classList.remove('show');
  }

  async function saveUser() {
    const data = {
      nombre: document.getElementById('userName').value,
      correo: document.getElementById('userEmail').value,
      password: 'cambiar123',
      rol: document.getElementById('userRole').value
    };
    
    if (!data.nombre || !data.correo) {
      showToast('Complete nombre y correo', 'error');
      return;
    }
    
    try {
      const response = await fetch(`${API_URL}/users`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (result.success) {
        showToast('Usuario agregado (password: cambiar123)', 'success');
        closeUserModal();
        loadUsers();
      } else {
        showToast('Error: ' + result.error, 'error');
      }
    } catch (error) {
      showToast('Error agregando usuario', 'error');
    }
  }

  async function deleteUser(id) {
    if (!confirm('¬øEliminar este usuario?')) return;
    
    try {
      const response = await fetch(`${API_URL}/users/${id}`, {
        method: 'DELETE'
      });
      
      const result = await response.json();
      
      if (result.success) {
        showToast('Usuario eliminado', 'success');
        loadUsers();
      }
    } catch (error) {
      showToast('Error eliminando usuario', 'error');
    }
  }

// ‚úÖ ACTUALIZAR CONFIGURACI√ìN DIN√ÅMICA DESDE EL BACKEND
async function updateSystemConfig() {
  try {
    // Obtener configuraci√≥n de la primera c√°mara activa
    const activeCamera = cameras.find(c => c.is_streaming);
    if (!activeCamera) return;
    
    const response = await fetch(`${API_URL}/cameras/${activeCamera.id}/stats`);
    const data = await response.json();
    
    if (data.success && data.stats) {
      const requiredFrames = data.stats.required_frames || 25;
      const cooldown = data.stats.cooldown_seconds || 30;
      
      // Actualizar panel de configuraci√≥n
      const requiredEl = document.getElementById('config-required-frames');
      const cooldownEl = document.getElementById('config-cooldown-seconds');
      
      if (requiredEl) requiredEl.innerText = `${requiredFrames} consecutivos`;
      if (cooldownEl) cooldownEl.innerText = `${cooldown} segundos`;
      
      // Actualizar todos los DVR que muestren el valor requerido
      cameras.forEach(cam => {
        const reqSpan = document.getElementById(`dvr-required-${cam.id}`);
        if (reqSpan) reqSpan.innerText = requiredFrames;
      });
    }
  } catch (error) {
    console.error('Error actualizando configuraci√≥n:', error);
  }
}
// ============================================
// üë• USUARIOS - EDICI√ìN
// ============================================
function openUserModal(mode, userId = null) {
  const modal = document.getElementById('userModalEdit');
  const title = document.getElementById('modalUserTitle');
  if (mode === 'create') {
    title.innerText = '‚ûï Agregar Usuario';
    document.getElementById('editUserId').value = '';
    document.getElementById('editUserName').value = '';
    document.getElementById('editUserEmail').value = '';
    document.getElementById('editUserPassword').value = '';
    document.getElementById('editUserRole').value = 'operador';
  } else if (mode === 'edit' && userId) {
    title.innerText = '‚úèÔ∏è Editar Usuario';
    const user = users.find(u => u.id === userId);
    if (user) {
      document.getElementById('editUserId').value = user.id;
      document.getElementById('editUserName').value = user.nombre;
      document.getElementById('editUserEmail').value = user.correo;
      document.getElementById('editUserPassword').value = '';
      document.getElementById('editUserRole').value = user.role;
    }
  }
  modal.classList.add('show');
}

function closeUserModalEdit() {
  document.getElementById('userModalEdit').classList.remove('show');
}

async function saveUserEdit() {
  const userId = document.getElementById('editUserId').value;
  const nombre = document.getElementById('editUserName').value.trim();
  const correo = document.getElementById('editUserEmail').value.trim();
  const password = document.getElementById('editUserPassword').value;
  const rol = document.getElementById('editUserRole').value;
  if (!nombre || !correo) { showToast('Nombre y correo requeridos', 'error'); return; }
  const session = getSession();
  const data = { nombre, correo, rol };
  if (password) data.password = password;
  try {
    const url = userId ? `${API_URL}/users/${userId}` : `${API_URL}/users`;
    const method = userId ? 'PUT' : 'POST';
    const response = await fetch(url, {
      method: method,
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.token}` },
      body: JSON.stringify(data)
    });
    const result = await response.json();
    if (result.success) {
      showToast(userId ? 'Usuario actualizado' : 'Usuario creado', 'success');
      closeUserModalEdit();
      loadUsers();
    } else {
      showToast('Error: ' + result.error, 'error');
    }
  } catch (error) {
    showToast('Error guardando usuario', 'error');
  }
}

function renderUsers() {
  const table = document.getElementById('usersTable');
  table.innerHTML = '';
  if (users.length === 0) {
    table.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;">No hay usuarios</td></tr>';
    return;
  }
  const session = getSession();
  const currentUserId = session ? session.user_id : null;
  users.forEach(user => {
    const roleColors = { 'admin': '#FFB300', 'operador': '#2196F3', 'emergencias': '#E53935' };
    const roleIcons = { 'admin': 'üëë', 'operador': 'üë®‚Äçüíº', 'emergencias': 'üö®' };
    const roleColor = roleColors[user.role] || '#999';
    const roleIcon = roleIcons[user.role] || 'üë§';
    const activo = user.activo !== false && user.activo !== 0;
    const lastLogin = user.last_login ? new Date(new Date(user.last_login).getTime() + 5 * 60 * 60 * 1000).toLocaleString('es-CO') : '<span style="color:#666;">Nunca</span>';
    const canDelete = user.id !== currentUserId;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-weight:bold;">${user.id}</td>
      <td>${user.nombre}</td>
      <td style="color:#999;">${user.correo}</td>
      <td><span style="color:${roleColor};font-weight:bold;">${roleIcon} ${user.role.toUpperCase()}</span></td>
      <td>${activo ? '<span style="color:#4CAF50;">‚úÖ Activo</span>' : '<span style="color:#E53935;">‚ùå Inactivo</span>'}</td>
      <td style="font-size:11px;color:#999;">${lastLogin}</td>
      <td>
        <button class="btn btn-warning" onclick="openUserModal('edit', ${user.id})" style="font-size:11px;padding:4px 8px;margin-right:4px;">‚úèÔ∏è Editar</button>
        ${canDelete ? `<button class="btn btn-danger" onclick="deleteUserConfirm(${user.id})" style="font-size:11px;padding:4px 8px;">üóëÔ∏è</button>` : '<span style="font-size:10px;color:#666;">(Usuario actual)</span>'}
      </td>
    `;
    table.appendChild(tr);
  });
  document.getElementById("dash-users").innerText = users.length;
}

async function deleteUserConfirm(userId) {
  if (!confirm('¬øEliminar este usuario?')) return;
  try {
    const session = getSession();
    const response = await fetch(`${API_URL}/users/${userId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${session.token}` }
    });
    const result = await response.json();
    if (result.success) {
      showToast('Usuario eliminado', 'success');
      loadUsers();
    } else {
      showToast('Error: ' + result.error, 'error');
    }
  } catch (error) {
    showToast('Error eliminando usuario', 'error');
  }
}

function getSession() {
  const localSession = localStorage.getItem('session');
  const sessionSession = sessionStorage.getItem('session');
  if (localSession) return JSON.parse(localSession);
  if (sessionSession) return JSON.parse(sessionSession);
  return null;
}

 function getToken() {
    const session = getSession();
    return session ? session.token : null;
  }

// Actualizar cada 10 segundos
setInterval(updateSystemConfig, 10000);

  // ============================================
  // CONFIGURACI√ìN
  // ============================================

  // ============================================
  // CONFIGURACI√ìN DEL SISTEMA
  // ============================================
  
  async function loadConfig() {
    try {
      const response = await fetch(`${API_URL}/config`, {
        headers: {
          'Authorization': `Bearer ${getToken()}`
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        const config = data.config;
        
        // Cargar valores en los inputs
        document.getElementById('config_frames_requeridos').value = config.frames_requeridos || 120;
        document.getElementById('config_cooldown_segundos').value = config.cooldown_segundos || 60;
        document.getElementById('config_confianza_minima').value = config.confianza_minima || 0.75;
        document.getElementById('config_tiempo_grabacion_pre').value = config.tiempo_grabacion_pre || 15;
        document.getElementById('config_tiempo_grabacion_post').value = config.tiempo_grabacion_post || 15;
        document.getElementById('config_ruta_videos').value = config.ruta_videos || '';
        document.getElementById('config_formato_video').value = config.formato_video || 'mp4';
        document.getElementById('config_notificaciones').value = config.notificaciones || 'all';
        
        showToast('Configuraci√≥n cargada correctamente', 'success');
      } else {
        showToast('Error cargando configuraci√≥n', 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showToast('Error conectando con el servidor', 'error');
    }
  }
  
  async function saveConfig() {
    try {
      const config = {
        frames_requeridos: parseInt(document.getElementById('config_frames_requeridos').value),
        cooldown_segundos: parseInt(document.getElementById('config_cooldown_segundos').value),
        confianza_minima: parseFloat(document.getElementById('config_confianza_minima').value),
        tiempo_grabacion_pre: parseInt(document.getElementById('config_tiempo_grabacion_pre').value),
        tiempo_grabacion_post: parseInt(document.getElementById('config_tiempo_grabacion_post').value),
        ruta_videos: document.getElementById('config_ruta_videos').value,
        formato_video: document.getElementById('config_formato_video').value,
        notificaciones: document.getElementById('config_notificaciones').value
      };
      
      // Validaciones
      if (config.frames_requeridos < 10 || config.frames_requeridos > 300) {
        showToast('Frames requeridos debe estar entre 10 y 300', 'error');
        return;
      }
      
      if (config.confianza_minima < 0.1 || config.confianza_minima > 1.0) {
        showToast('Confianza debe estar entre 0.1 y 1.0', 'error');
        return;
      }
      
      showToast('Guardando configuraci√≥n...', 'info');
      
      const response = await fetch(`${API_URL}/config`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getToken()}`
        },
        body: JSON.stringify(config)
      });
      
      const data = await response.json();
      
      if (data.success) {
        showToast('‚úÖ Configuraci√≥n guardada y aplicada', 'success');
        setTimeout(() => loadConfig(), updateLiveConfig(), 1000);
      } else {
        showToast('Error: ' + (data.error || 'Desconocido'), 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showToast('Error guardando configuraci√≥n', 'error');
    }
  }
  
  async function resetConfig() {
    if (!confirm('¬øRestaurar valores por defecto? Las c√°maras activas se reiniciar√°n.')) return;
    
    try {
      const defaultConfig = {
        frames_requeridos: 120,
        cooldown_segundos: 60,
        confianza_minima: 0.75,
        tiempo_grabacion_pre: 15,
        tiempo_grabacion_post: 15,
        ruta_videos: 'C:\\Users\\Ramirez\\Desktop\\ACCIDENT\\BACKEND\\clips',
        formato_video: 'mp4',
        notificaciones: 'all'
      };
      
      const response = await fetch(`${API_URL}/config`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getToken()}`
        },
        body: JSON.stringify(defaultConfig)
      });
      
      const data = await response.json();
      
      if (data.success) {
        showToast('Configuraci√≥n restaurada a valores por defecto', 'success');
        setTimeout(() => loadConfig(), 1000);
      }
    } catch (error) {
      showToast('Error restaurando configuraci√≥n', 'error');
    }
  }

  // ============================================
  // MAPA Y REPORTES
  // ============================================

  function toggleHeatmap() {
    const info = document.getElementById('heatmapInfo');
    const isActive = info.style.display !== 'none';
    info.style.display = isActive ? 'none' : 'block';
    showToast(isActive ? 'Mapa de calor desactivado' : 'Mapa de calor activado', 'info');
    }

// ============================================
  // SISTEMA DE REPORTES
  // ============================================
  
  let currentReportTab = 'audit';
  
  function showReportTab(tab) {
    currentReportTab = tab;
    
    // Ocultar todos los contenidos
    document.querySelectorAll('.report-content').forEach(el => el.style.display = 'none');
    
    // Quitar estilo activo de todos los tabs
    document.getElementById('tab-audit').className = 'btn';
    document.getElementById('tab-audit').style.background = '#3E3E42';
    document.getElementById('tab-access').className = 'btn';
    document.getElementById('tab-access').style.background = '#3E3E42';
    document.getElementById('tab-accidents').className = 'btn';
    document.getElementById('tab-accidents').style.background = '#3E3E42';
    
    // Mostrar contenido activo
    document.getElementById(`report-${tab}-content`).style.display = 'block';
    document.getElementById(`tab-${tab}`).className = 'btn btn-primary';
    
    // Cargar datos
    loadReportData(tab);
  }
  
  async function loadAllReports() {
    showToast('Actualizando reportes...', 'info');
    await loadReportData(currentReportTab);
  }
  
  async function loadReportData(type) {
    const startDate = document.getElementById('report-start-date').value;
    const endDate = document.getElementById('report-end-date').value;
    
    let url = `${API_URL}/reports/${type}?`;
    if (startDate) url += `start_date=${startDate}&`;
    if (endDate) url += `end_date=${endDate}`;
    
    try {
      const response = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${getToken()}`
        }
      });
      const data = await response.json();
      
      if (data.success) {
        if (type === 'audit') populateAuditTable(data.data);
        else if (type === 'access') populateAccessTable(data.data);
        else if (type === 'accidents') populateAccidentsTable(data.data);
        
        showToast(`${data.count} registros cargados`, 'success');
      } else {
        showToast('Error cargando reportes: ' + (data.error || 'Desconocido'), 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showToast('Error conectando con el servidor', 'error');
    }
  }
  
  function populateAuditTable(data) {
    const tbody = document.getElementById('audit-table-body');
    tbody.innerHTML = '';
    
    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;">No hay registros</td></tr>';
      return;
    }
    
    data.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.id}</td>
        <td>${row.tipo_evento || 'N/A'}</td>
        <td>${row.nombre_usuario || 'Sistema'}</td>
        <td>${row.descripcion || ''}</td>
        <td>${new Date(row.fecha_hora).toLocaleString('es-CO')}</td>
        <td>${row.ip_usuario || 'N/A'}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  function populateAccessTable(data) {
    const tbody = document.getElementById('access-table-body');
    tbody.innerHTML = '';
    
    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;">No hay registros</td></tr>';
      return;
    }
    
    data.forEach(row => {
      const tr = document.createElement('tr');
      const estadoColor = row.estado === 'Exitoso' ? '#4CAF50' : row.estado === 'Fallido' ? '#E53935' : '#FF9800';
      
      tr.innerHTML = `
        <td>${row.id}</td>
        <td>${new Date(row.fecha_hora).toLocaleString('es-CO')}</td>
        <td>${row.nombre_usuario || 'N/A'}</td>
        <td>${row.correo || 'N/A'}</td>
        <td>${row.rol || 'N/A'}</td>
        <td><span style="color:${estadoColor};">‚óè ${row.estado}</span></td>
        <td>${row.ip_usuario || 'N/A'}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  function populateAccidentsTable(data) {
    const tbody = document.getElementById('accidents-table-body');
    tbody.innerHTML = '';
    
    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;">No hay registros</td></tr>';
      return;
    }
    
    data.forEach(row => {
      const tr = document.createElement('tr');
      const videoName = row.ruta_archivo ? row.ruta_archivo.split('\\').pop() : 'N/A';
      
      tr.innerHTML = `
        <td>${row.id}</td>
        <td>${new Date(row.fecha_deteccion).toLocaleString('es-CO')}</td>
        <td>${row.camera_ip || 'C√°mara ' + (row.camara_id || 'N/A')}</td>
        <td>${row.camera_location || 'N/A'}</td>
        <td>${row.latitud ? parseFloat(row.latitud).toFixed(6) : 'N/A'}</td>
        <td>${row.longitud ? parseFloat(row.longitud).toFixed(6) : 'N/A'}</td>
        <td>${videoName}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  function exportReport(type) {
    let data = [];
    let filename = `reporte_${type}_${new Date().toISOString().split('T')[0]}.csv`;
    
    if (type === 'audit') {
      const rows = document.querySelectorAll('#audit-table-body tr');
      data = Array.from(rows).map(tr => {
        const cells = tr.querySelectorAll('td');
        return Array.from(cells).map(td => `"${td.innerText}"`).join(',');
      });
      data.unshift('ID,Tipo Evento,Usuario,Descripci√≥n,Fecha/Hora,IP');
    } else if (type === 'access') {
      const rows = document.querySelectorAll('#access-table-body tr');
      data = Array.from(rows).map(tr => {
        const cells = tr.querySelectorAll('td');
        return Array.from(cells).map(td => `"${td.innerText}"`).join(',');
      });
      data.unshift('ID,Fecha/Hora,Usuario,Correo,Rol,Estado,IP');
    } else if (type === 'accidents') {
      const rows = document.querySelectorAll('#accidents-table-body tr');
      data = Array.from(rows).map(tr => {
        const cells = tr.querySelectorAll('td');
        return Array.from(cells).map(td => `"${td.innerText}"`).join(',');
      });
      data.unshift('ID,Fecha/Hora,C√°mara,Ubicaci√≥n,Latitud,Longitud,Video');
    }
    
    const csv = data.join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast(`Reporte exportado: ${filename}`, 'success');
  }

  function generateReport() {
    showReportTab('audit');
  }

  // ============================================
  // DASHBOARD
  // ============================================

  function updateDashboard() {
    document.getElementById('dash-cams').innerText = cameras.length;
    document.getElementById('dash-accidents').innerText = accidents.length;
    document.getElementById('dash-users').innerText = users.length;
  }

  // ============================================
  // UTILIDADES
  // ============================================

  function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${message}`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }

  // Reloj
  setInterval(() => {
    document.getElementById("current-time").innerText = new Date().toLocaleTimeString();
  }, 1000);

  // ============================================
  // INICIALIZACI√ìN
  // ============================================


window.onload = function() {
  console.log('%cüéØ SISTEMA DE DETECCI√ìN YOLO INICIADO', 'color: #4CAF50; font-size: 16px; font-weight: bold;');
  console.log('%cCaracter√≠sticas:', 'color: #999; font-size: 12px;');
  console.log('%c  ‚úì Detecci√≥n en tiempo real', 'color: #4CAF50; font-size: 12px;');
  console.log('%c  ‚úì Verificaci√≥n anti falsos positivos (25 frames)', 'color: #4CAF50; font-size: 12px;');
  console.log('%c  ‚úì Cooldown de 30 segundos entre confirmaciones', 'color: #4CAF50; font-size: 12px;');
  console.log('%c  ‚úì Notificaciones de escritorio', 'color: #4CAF50; font-size: 12px;');
  console.log('%c  ‚úì Overlay de estad√≠sticas en DVR', 'color: #4CAF50; font-size: 12px;');
  showToast('Conectando con el backend...', 'info');
  
  // ‚úÖ AGREGAR ESTA L√çNEA
  setTimeout(updateSystemConfig, 2000); // Actualizar config despu√©s de 2 segundos
};

</script>
</body>
</html>